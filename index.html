<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="FaB Bericht">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0d0d0f">
<title>FaB Inventar-Bericht</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Source+Sans+3:wght@400;500;600;700&family=Source+Code+Pro:wght@400;500&display=swap');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESIGN TOKENS â€” FaB offizielle Ã„sthetik
   Basis: Tiefes Schwarz / Leder-Dunkel / Gold
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  /* HintergrÃ¼nde */
  --bg:         #0a0b0e;
  --bg-deep:    #060709;
  --surface:    #13151c;
  --surface2:   #1a1d27;
  --surface3:   #21253380;

  /* RÃ¤nder & Trennlinien */
  --border:     #2e3347;
  --border-lit: #4a5070;

  /* PrimÃ¤r-Akzent: FaB-Gold */
  --gold:       #c9963a;
  --gold-light: #e8b84b;
  --gold-dim:   #7a5b22;
  --gold-glow:  rgba(201,150,58,.15);

  /* SekundÃ¤r-Akzent: FaB-Rot */
  --red:        #c0392b;
  --red-light:  #e74c3c;

  /* Karten-Farben */
  --c-red:      #e05555;
  --c-yellow:   #d4b84a;
  --c-blue:     #5588d4;
  --c-neutral:  #8892a4;

  /* Seltenheiten */
  --common:     #5eac7a;
  --rare:       #9b6cc8;

  /* Text */
  --text:       #e8ecf5;
  --text-dim:   #a0a8bc;
  --text-muted: #606780;

  /* Gefahr */
  --danger:     #e05555;

  /* Schriften */
  --font-display: 'Cinzel', Georgia, serif;
  --font-body:    'Source Sans 3', system-ui, sans-serif;
  --font-mono:    'Source Code Pro', 'Courier New', monospace;

  /* Spacing & Radius */
  --radius:     6px;
  --radius-lg:  10px;
}

/* â”€â”€ Reset & Base â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html { font-size: 16px; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-body);
  font-size: 1rem;
  line-height: 1.5;
  min-height: 100vh;
  overflow-x: hidden;
}

/* Dezente Textur im Hintergrund */
body::before {
  content: '';
  position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background-image:
    radial-gradient(ellipse 80% 60% at 50% 0%, rgba(201,150,58,.06) 0%, transparent 60%),
    url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.015'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SEKTION-NAVIGATION (Hauptsets / Andere Produkte)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sektion-nav {
  display: flex; gap: 6px;
  background: var(--bg-deep);
  border-bottom: 1px solid var(--border);
  padding: 0 32px;
}
.sektion-btn {
  position: relative;
  padding: 14px 28px;
  font-family: var(--font-display);
  font-size: .875rem; font-weight: 600;
  letter-spacing: .06em; text-transform: uppercase;
  color: var(--text-muted); background: transparent; border: none; cursor: pointer;
  border-bottom: 3px solid transparent; margin-bottom: -1px;
  transition: color .15s, border-color .15s;
  min-height: 52px;
}
.sektion-btn:hover { color: var(--text); }
.sektion-btn.active { color: var(--gold-light); border-bottom-color: var(--gold); }
.sektion-btn .s-badge {
  display: inline-flex; align-items: center; justify-content: center;
  font-family: var(--font-mono); font-size: .6875rem;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 10px; padding: 1px 7px; margin-left: 7px;
  color: var(--text-muted); vertical-align: middle;
  transition: background .15s, color .15s;
}
.sektion-btn.active .s-badge {
  background: var(--gold-dim); color: var(--gold-light); border-color: var(--gold-dim);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SELTENHEITS-FARBEN (erweitert)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --majestic:    #c8883a;
  --super-rare:  #4a8fcc;
  --legendary:   #c8a03a;
  --fabled:      #c83a3a;
  --marvel:      #8f4acc;
  --promo:       #3acc8f;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FILTER-BAR (Seltenheit + Foil)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.filter-bar {
  display: flex; align-items: center; flex-wrap: wrap;
  gap: 6px 10px;
  padding: 10px 16px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  margin-bottom: 12px;
}
.filter-label {
  font-family: var(--font-display);
  font-size: .625rem; font-weight: 600;
  letter-spacing: .1em; text-transform: uppercase;
  color: var(--text-muted);
  white-space: nowrap;
}
.filter-sep {
  width: 1px; height: 20px;
  background: var(--border);
  flex-shrink: 0;
}
.filter-group { display: flex; flex-wrap: wrap; gap: 4px; }

/* Filter-Toggle-Buttons */
.ftog {
  padding: 4px 10px; border-radius: 4px;
  font-family: var(--font-body); font-size: .8125rem; font-weight: 500;
  border: 1px solid var(--border); background: var(--bg); color: var(--text-muted);
  cursor: pointer; transition: all .15s;
  min-height: 28px;
}
.ftog:hover { border-color: var(--border-lit); color: var(--text); }
.ftog.on {
  background: color-mix(in srgb, var(--fcol, var(--gold)) 15%, transparent);
  border-color: var(--fcol, var(--gold));
  color: var(--fcol, var(--gold));
}
/* Foil-spezifische Farben */
.ftog.foil-rf { --fcol: #b07fd4; }
.ftog.foil-cf { --fcol: #5b9bd5; }

/* Such-Zeile (ohne Filter-Toggles, die sind in filter-bar) */
.search-row {
  display: flex; gap: 8px; align-items: center;
  margin-bottom: 10px;
}

/* Foil-Tags in der Kartenzeile */
.foil-tag {
  display: inline-block;
  font-family: var(--font-mono); font-size: .6rem; font-weight: 700;
  padding: 1px 5px; border-radius: 3px; margin-right: 5px;
  vertical-align: middle; letter-spacing: .05em;
}
.foil-tag.rf { background: rgba(176,127,212,.2); color: #b07fd4; border: 1px solid rgba(176,127,212,.3); }
.foil-tag.cf { background: rgba(91,155,213,.2);  color: #5b9bd5; border: 1px solid rgba(91,155,213,.3); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header {
  position: relative; z-index: 10;
  background: var(--bg-deep);
  border-bottom: 1px solid var(--gold-dim);
  padding: 0 32px;
  display: flex; align-items: center; gap: 20px;
  height: 72px;
  box-shadow: 0 2px 20px rgba(0,0,0,.5);
}

header::after {
  content: '';
  position: absolute; bottom: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold), transparent);
  opacity: .5;
}

.header-emblem {
  width: 48px; height: 48px; flex-shrink: 0;
  background: linear-gradient(135deg, var(--gold-dim), var(--gold));
  clip-path: polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);
  display: flex; align-items: center; justify-content: center;
  font-size: 22px; filter: drop-shadow(0 0 8px var(--gold-dim));
}

.header-text h1 {
  font-family: var(--font-display);
  font-size: 1.375rem;
  font-weight: 700;
  letter-spacing: .08em;
  text-transform: uppercase;
  color: var(--gold-light);
  text-shadow: 0 0 20px var(--gold-dim);
}

.header-text p {
  font-family: var(--font-mono);
  font-size: .6875rem;
  color: var(--text-muted);
  letter-spacing: .06em;
  margin-top: 1px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.app {
  position: relative; z-index: 1;
  display: grid;
  grid-template-columns: 360px 1fr;
  height: calc(100vh - 72px);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDEBAR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sidebar {
  background: var(--surface);
  border-right: 1px solid var(--border);
  padding: 24px 20px;
  display: flex; flex-direction: column; gap: 24px;
  overflow-y: auto;
}

.section-heading {
  display: flex; align-items: center; gap: 8px;
  font-family: var(--font-display);
  font-size: .6875rem;
  font-weight: 600;
  letter-spacing: .12em;
  text-transform: uppercase;
  color: var(--gold);
  margin-bottom: 10px;
}
.section-heading::after {
  content: '';
  flex: 1; height: 1px;
  background: linear-gradient(90deg, var(--gold-dim), transparent);
}

/* â”€â”€ Drop Zones â”€â”€ */
.drop-zone {
  border: 2px dashed var(--border);
  border-radius: var(--radius-lg);
  padding: 20px 18px;
  cursor: pointer;
  transition: border-color .2s, background .2s, box-shadow .2s;
  position: relative;
  background: var(--bg);
  min-height: 110px;
}
.drop-zone:hover,
.drop-zone:focus-within {
  border-color: var(--gold);
  background: var(--gold-glow);
  box-shadow: 0 0 0 3px rgba(201,150,58,.2);
}
.drop-zone.drag-over {
  border-color: var(--gold-light);
  background: rgba(201,150,58,.1);
  box-shadow: 0 0 0 4px rgba(201,150,58,.25);
}
.drop-zone.loaded {
  border-color: var(--common);
  border-style: solid;
  background: rgba(94,172,122,.06);
}
.drop-zone.errored {
  border-color: var(--danger);
  background: rgba(224,85,85,.05);
}

.drop-zone input[type=file] {
  position: absolute; inset: 0;
  opacity: 0; cursor: pointer;
  width: 100%; height: 100%;
}

.dz-inner { pointer-events: none; }
.dz-icon  { font-size: 28px; margin-bottom: 8px; display: block; }
.dz-title {
  font-family: var(--font-display);
  font-size: 1rem;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 4px;
}
.dz-hint {
  font-size: .875rem;
  color: var(--text-muted);
  line-height: 1.4;
}
.dz-status {
  font-family: var(--font-mono);
  font-size: .75rem;
  margin-top: 8px;
  line-height: 1.4;
  word-break: break-all;
}
.dz-status.ok  { color: var(--common); }
.dz-status.err { color: var(--danger); }

/* â”€â”€ Config â”€â”€ */
.config-card {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px 16px;
}
.config-row {
  display: flex; align-items: center;
  justify-content: space-between; gap: 12px;
}
.config-label {
  font-size: .9375rem;
  color: var(--text-dim);
  font-weight: 500;
}
.config-input {
  background: var(--surface2);
  border: 2px solid var(--border);
  border-radius: var(--radius);
  color: var(--text);
  font-family: var(--font-mono);
  font-size: .9375rem;
  padding: 6px 12px;
  width: 80px;
  text-align: right;
  outline: none;
  transition: border-color .15s, box-shadow .15s;
}
.config-input:focus {
  border-color: var(--gold);
  box-shadow: 0 0 0 3px rgba(201,150,58,.2);
}

/* â”€â”€ Buttons â”€â”€ */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 8px;
  border-radius: var(--radius);
  font-family: var(--font-display);
  font-size: 1rem;
  font-weight: 600;
  letter-spacing: .06em;
  text-transform: uppercase;
  cursor: pointer;
  width: 100%;
  padding: 14px 20px;
  min-height: 52px;
  transition: all .2s;
  border: 2px solid transparent;
  position: relative;
  overflow: hidden;
}
.btn:focus-visible {
  outline: 3px solid var(--gold-light);
  outline-offset: 3px;
}
.btn:disabled {
  opacity: .35;
  cursor: not-allowed;
  pointer-events: none;
}

.btn-primary {
  background: linear-gradient(135deg, var(--gold-dim), var(--gold));
  color: #0a0b0e;
  border-color: var(--gold);
  box-shadow: 0 2px 12px rgba(201,150,58,.3);
}
.btn-primary:hover:not(:disabled) {
  background: linear-gradient(135deg, var(--gold), var(--gold-light));
  box-shadow: 0 4px 20px rgba(201,150,58,.45);
  transform: translateY(-1px);
}
.btn-primary:active:not(:disabled) { transform: translateY(0); }

.btn-secondary {
  background: transparent;
  color: var(--gold-light);
  border-color: var(--gold-dim);
}
.btn-secondary:hover:not(:disabled) {
  background: var(--gold-glow);
  border-color: var(--gold);
}

/* â”€â”€ Status message â”€â”€ */
.status-msg {
  font-family: var(--font-mono);
  font-size: .8125rem;
  text-align: center;
  min-height: 20px;
  line-height: 1.4;
  padding: 0 4px;
}
.status-msg.running { color: var(--gold-light); }
.status-msg.done    { color: var(--common); }
.status-msg.err     { color: var(--danger); }

@keyframes spin { to { transform: rotate(360deg); } }
.spinner {
  display: inline-block; width: 14px; height: 14px;
  border: 2px solid var(--border-lit);
  border-top-color: var(--gold);
  border-radius: 50%;
  animation: spin .7s linear infinite;
  vertical-align: middle; margin-right: 6px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN AREA
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.main {
  overflow-y: auto;
  display: flex; flex-direction: column;
}

/* â”€â”€ Empty state â”€â”€ */
.empty-state {
  flex: 1;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 16px; padding: 48px;
  text-align: center; color: var(--text-muted);
}
.empty-state .emblem {
  font-size: 64px;
  filter: grayscale(1) opacity(.3);
}
.empty-state h2 {
  font-family: var(--font-display);
  font-size: 1.5rem;
  color: var(--text-dim);
  letter-spacing: .04em;
}
.empty-state p {
  font-size: .9375rem;
  max-width: 340px;
  line-height: 1.6;
}

/* â”€â”€ Result â”€â”€ */
.result-area { padding: 24px 28px; }

/* â”€â”€ Stat cards â”€â”€ */
.stats-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  margin-bottom: 24px;
}
.stat-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 16px 18px;
  position: relative;
  overflow: hidden;
}
.stat-card::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; height: 2px;
}
.stat-card.s-total::before  { background: var(--gold); }
.stat-card.s-common::before { background: var(--common); }
.stat-card.s-rare::before   { background: var(--rare); }
.stat-card.s-null::before   { background: var(--danger); }

.stat-val {
  font-family: var(--font-display);
  font-size: 2rem;
  font-weight: 700;
  line-height: 1;
  margin-bottom: 4px;
}
.stat-card.s-total  .stat-val { color: var(--gold-light); }
.stat-card.s-common .stat-val { color: var(--common); }
.stat-card.s-rare   .stat-val { color: var(--rare); }
.stat-card.s-null   .stat-val { color: var(--danger); }

.stat-lbl {
  font-family: var(--font-mono);
  font-size: .6875rem;
  letter-spacing: .06em;
  color: var(--text-muted);
  text-transform: uppercase;
}

/* â”€â”€ Tabs â”€â”€ */
.tabs {
  display: flex; gap: 4px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 4px;
  margin-bottom: 18px;
}
.tab {
  flex: 1;
  padding: 9px 20px;
  cursor: pointer;
  font-family: var(--font-display);
  font-size: .8125rem;
  font-weight: 600;
  letter-spacing: .06em;
  text-transform: uppercase;
  color: var(--text-muted);
  background: transparent;
  border: none;
  border-radius: calc(var(--radius) - 2px);
  transition: color .15s, background .15s;
  user-select: none;
  text-align: center;
}
.tab:hover { color: var(--text); background: var(--surface2); }
.tab.active {
  color: var(--gold-light);
  background: var(--surface2);
  box-shadow: inset 0 0 0 1px var(--gold-dim);
}
.tab:focus-visible { outline: 2px solid var(--gold-light); outline-offset: 2px; }

/* â”€â”€ Tables â”€â”€ */
.table-wrap { overflow-x: auto; border-radius: var(--radius); }

table {
  width: 100%;
  border-collapse: collapse;
  font-size: .9375rem;
}

thead tr {
  background: var(--surface2);
  border-bottom: 2px solid var(--gold-dim);
}
thead th {
  font-family: var(--font-mono);
  font-size: .6875rem;
  letter-spacing: .08em;
  text-transform: uppercase;
  color: var(--text-muted);
  padding: 10px 12px;
  text-align: left;
  white-space: nowrap;
  cursor: pointer;
  user-select: none;
  transition: color .15s;
}
thead th:hover { color: var(--text); }
thead th.num { text-align: right; }
thead th.sorted { color: var(--gold-light); }
.sort-arrow { margin-left: 4px; opacity: .4; }
thead th.sorted .sort-arrow { opacity: 1; }

tbody tr {
  border-bottom: 1px solid rgba(46,51,71,.6);
  transition: background .1s;
}
tbody tr:hover { background: var(--surface2); }
tbody tr:focus-within { background: var(--surface2); }

td {
  padding: 10px 12px;
  vertical-align: middle;
  font-size: .9375rem;
}
td.num {
  text-align: right;
  font-family: var(--font-mono);
  font-size: .875rem;
}

/* â”€â”€ Ranking â”€â”€ */
.rank-num {
  font-family: var(--font-mono);
  font-size: .75rem;
  color: var(--text-muted);
  min-width: 28px;
  display: inline-block;
}

.badge-fe {
  display: inline-block;
  font-family: var(--font-mono);
  font-size: .625rem;
  letter-spacing: .04em;
  padding: 2px 6px;
  border-radius: 3px;
  margin-left: 6px;
  background: rgba(155,108,200,.2);
  color: var(--rare);
  border: 1px solid rgba(155,108,200,.3);
  vertical-align: middle;
}

.bar-cell { display: flex; align-items: center; gap: 10px; }
.bar-bg {
  flex: 1; max-width: 90px; height: 5px;
  background: var(--border);
  border-radius: 3px; overflow: hidden;
}
.bar-fill {
  height: 100%; border-radius: 3px;
  background: linear-gradient(90deg, var(--gold-dim), var(--gold-light));
}
.bar-val {
  font-family: var(--font-mono);
  font-size: .875rem;
  color: var(--gold-light);
  min-width: 42px;
  font-weight: 500;
}

/* â”€â”€ Set filter buttons â”€â”€ */
.set-filter {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 6px;
  margin-bottom: 14px;
}
.set-btn {
  padding: 8px 14px;
  border-radius: var(--radius);
  cursor: pointer;
  font-family: var(--font-body);
  font-size: .875rem;
  font-weight: 600;
  border: 1.5px solid var(--border);
  background: var(--surface);
  color: var(--text-dim);
  transition: all .15s;
  line-height: 1.3;
  text-align: left;
  display: flex;
  flex-direction: column;
  gap: 2px;
  white-space: normal;        /* voller Name, kein Abschneiden */
  word-break: break-word;
}
.set-btn-name {
  display: block;
  color: inherit;
  font-size: .875rem;
  font-weight: 600;
  line-height: 1.35;
}
.set-btn-count {
  display: block;
  font-family: var(--font-mono);
  font-size: .6875rem;
  opacity: .55;
  font-weight: 400;
}
.set-btn:hover {
  border-color: var(--gold-dim);
  color: var(--text);
  background: var(--gold-glow);
}
.set-btn:focus-visible {
  outline: 2px solid var(--gold-light);
  outline-offset: 2px;
}
.set-btn.active {
  background: var(--gold-glow);
  border-color: var(--gold);
  color: var(--gold-light);
}
.set-btn.fe { border-color: rgba(155,108,200,.35); }
.set-btn.fe:hover { border-color: var(--rare); }
.set-btn.fe.active {
  background: rgba(155,108,200,.12);
  border-color: var(--rare);
  color: #c4a0e8;
}

/* â”€â”€ Set-Code Badge in Kartentabelle â”€â”€ */
.set-code-badge {
  display: inline-block;
  font-family: var(--font-mono);
  font-size: .6875rem;
  font-weight: 600;
  letter-spacing: .04em;
  padding: 2px 7px;
  border-radius: 3px;
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text-muted);
  white-space: nowrap;
}

/* â”€â”€ Card filter row â”€â”€ */
.filter-row {
  display: flex; gap: 10px; align-items: center;
  margin-bottom: 14px; flex-wrap: wrap;
}
.search-input {
  background: var(--surface);
  border: 2px solid var(--border);
  border-radius: var(--radius);
  padding: 9px 14px;
  color: var(--text);
  font-family: var(--font-body);
  font-size: .9375rem;
  flex: 1; min-width: 180px;
  outline: none;
  transition: border-color .15s, box-shadow .15s;
}
.search-input:focus {
  border-color: var(--gold);
  box-shadow: 0 0 0 3px rgba(201,150,58,.2);
}
.search-input::placeholder { color: var(--text-muted); }

.rtog-group { display: flex; gap: 4px; }
.rtog {
  padding: 8px 16px;
  border-radius: var(--radius);
  cursor: pointer;
  font-family: var(--font-body);
  font-size: .875rem;
  font-weight: 600;
  border: 1.5px solid var(--border);
  background: var(--surface);
  color: var(--text-muted);
  transition: all .15s;
  min-height: 40px;
}
.rtog:hover { color: var(--text); }
.rtog:focus-visible { outline: 2px solid var(--gold-light); outline-offset: 2px; }
.rtog.c.on {
  background: rgba(94,172,122,.15);
  border-color: var(--common);
  color: var(--common);
}
.rtog.r.on {
  background: rgba(155,108,200,.15);
  border-color: var(--rare);
  color: #c4a0e8;
}

.count-lbl {
  font-family: var(--font-mono);
  font-size: .8125rem;
  color: var(--text-muted);
  white-space: nowrap;
  margin-left: auto;
}

/* â”€â”€ Card dot â”€â”€ */
.dot {
  display: inline-block;
  width: 9px; height: 9px;
  border-radius: 50%;
  margin-right: 7px;
  flex-shrink: 0;
  vertical-align: middle;
  position: relative; top: -1px;
}

/* â”€â”€ Progress â”€â”€ */
.prog-cell { display: flex; align-items: center; gap: 8px; }
.prog-bg {
  width: 56px; height: 5px;
  background: var(--border); border-radius: 3px; overflow: hidden;
  flex-shrink: 0;
}
.prog-fill {
  height: 100%; border-radius: 3px;
  background: linear-gradient(90deg, #3a6bc0, var(--c-blue));
}
.prog-txt {
  font-family: var(--font-mono);
  font-size: .8125rem;
  color: var(--text-dim);
  white-space: nowrap;
}

.zero-badge {
  display: inline-block;
  font-family: var(--font-mono);
  font-size: .625rem;
  padding: 2px 6px;
  border-radius: 3px;
  background: rgba(224,85,85,.18);
  color: var(--danger);
  border: 1px solid rgba(224,85,85,.3);
  flex-shrink: 0;
}

/* â”€â”€ Utility â”€â”€ */
.sr-only {
  position: absolute; width: 1px; height: 1px;
  padding: 0; margin: -1px; overflow: hidden;
  clip: rect(0,0,0,0); white-space: nowrap; border: 0;
}

/* â”€â”€ Divider â”€â”€ */
.gold-divider {
  border: none;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold-dim), transparent);
  margin: 4px 0;
  opacity: .5;
}



/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CACHE-STATUS (Kartenliste gespeichert)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.cache-info {
  display: flex; align-items: center; justify-content: space-between;
  gap: 8px;
  padding: 8px 12px;
  background: color-mix(in srgb, var(--gold) 8%, transparent);
  border: 1px solid var(--gold-dim);
  border-radius: var(--radius);
  font-size: .8125rem;
}
.cache-info-text {
  color: var(--text-dim);
  font-family: var(--font-mono);
  font-size: .75rem;
  line-height: 1.4;
}
.cache-info-text strong {
  display: block;
  color: var(--gold-light);
  font-size: .8125rem;
  margin-bottom: 1px;
}
.btn-cache-clear {
  flex-shrink: 0;
  padding: 4px 10px;
  font-size: .75rem;
  font-family: var(--font-body);
  font-weight: 600;
  background: transparent;
  border: 1px solid var(--border-lit);
  border-radius: var(--radius);
  color: var(--text-muted);
  cursor: pointer;
  transition: all .15s;
  white-space: nowrap;
}
.btn-cache-clear:hover {
  border-color: var(--danger);
  color: var(--danger);
}
.cache-info-warn {
  background: color-mix(in srgb, var(--majestic) 8%, transparent);
  border-color: color-mix(in srgb, var(--majestic) 40%, transparent);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DIFFERENZBERICHT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.diff-banner {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 16px;
  background: color-mix(in srgb, var(--gold) 8%, transparent);
  border: 1px solid var(--gold-dim);
  border-radius: var(--radius);
  margin-bottom: 18px;
  font-size: .875rem;
  color: var(--text-dim);
}
.diff-banner-icon { font-size: 1.4rem; flex-shrink: 0; }
.diff-banner-text strong { color: var(--gold-light); display: block; margin-bottom: 2px; }
.diff-sold-badge {
  display: inline-flex; align-items: center; gap: 4px;
  background: color-mix(in srgb, #e05c5c 15%, transparent);
  border: 1px solid color-mix(in srgb, #e05c5c 40%, transparent);
  color: #e05c5c;
  font-family: var(--font-mono); font-size: .75rem; font-weight: 700;
  padding: 1px 7px; border-radius: 10px;
}
.diff-new-badge {
  display: inline-flex; align-items: center; gap: 4px;
  background: color-mix(in srgb, var(--gold) 15%, transparent);
  border: 1px solid var(--gold-dim);
  color: var(--gold-light);
  font-family: var(--font-mono); font-size: .75rem; font-weight: 700;
  padding: 1px 7px; border-radius: 10px;
}
.diff-arrow { color: var(--text-muted); font-size: .8rem; }
.diff-ts { font-size: .75rem; color: var(--text-muted); font-family: var(--font-mono); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KARTENERFASSUNG
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#scan-panel {
  padding: 20px 0 0;
}
.scan-video-wrap {
  position: relative;
  width: 100%;
  max-width: 480px;
  margin: 0 auto 16px;
  border-radius: var(--radius);
  overflow: hidden;
  background: #000;
  border: 1px solid var(--border);
}
.scan-video-wrap video {
  width: 100%; display: block;
}
.scan-overlay {
  position: absolute; inset: 0;
  pointer-events: none;
}
.scan-guide-wrap {
  position: absolute; inset: 0; pointer-events: none;
}
/* Pitch-Farbstreifen: obere 10% */
.scan-zone-pitch {
  position: absolute;
  top: 3%; left: 5%; right: 5%; height: 9%;
  border: 2px solid #b07fd4;
  border-radius: 4px;
}
.scan-zone-pitch-label {
  position: absolute; top: -18px; left: 0;
  font-size: .65rem; color: #b07fd4;
  letter-spacing: .05em; font-family: var(--font-display);
}
/* Name: 13%â€“28% */
.scan-zone-name {
  position: absolute;
  top: 13%; left: 5%; right: 5%; height: 16%;
  border: 2px solid var(--gold);
  border-radius: 4px;
}
.scan-zone-name-label {
  position: absolute; top: -18px; left: 0;
  font-size: .65rem; color: var(--gold-light);
  letter-spacing: .05em; font-family: var(--font-display);
}
/* Setcode: untere 10% */
.scan-zone-set {
  position: absolute;
  bottom: 3%; left: 5%; right: 5%; height: 9%;
  border: 2px solid #5b9bd5;
  border-radius: 4px;
}
.scan-zone-set-label {
  position: absolute; bottom: -18px; left: 0;
  font-size: .65rem; color: #5b9bd5;
  letter-spacing: .05em; font-family: var(--font-display);
}
.scan-controls {
  display: flex; gap: 10px; justify-content: center;
  margin-bottom: 18px; flex-wrap: wrap;
}
.scan-result {
  max-width: 480px; margin: 0 auto 12px;
  border-radius: var(--radius);
  overflow: hidden;
  border: 1px solid var(--border);
}
.scan-result-inner {
  padding: 16px 20px;
  display: flex; align-items: center; gap: 16px;
}
.scan-result.needed   { border-color: var(--gold); background: color-mix(in srgb, var(--gold) 8%, transparent); }
.scan-result.not-needed { border-color: var(--border); background: var(--surface); }
.scan-result.scanning { border-color: var(--border); background: var(--surface); }
.scan-result-icon { font-size: 2rem; flex-shrink: 0; }
.scan-result-name { font-family: var(--font-display); font-size: 1rem; color: var(--text); font-weight: 600; }
.scan-result-detail { font-size: .8125rem; color: var(--text-muted); margin-top: 3px; }
.scan-result-qty {
  margin-left: auto; flex-shrink: 0;
  font-family: var(--font-mono); font-size: 1.5rem; font-weight: 700;
  color: var(--gold-light);
}
.scan-result-qty.zero { color: var(--text-muted); }
.scan-log {
  max-width: 480px; margin: 0 auto;
  max-height: 220px; overflow-y: auto;
}
.scan-log-entry {
  display: flex; align-items: center; gap: 10px;
  padding: 7px 10px;
  border-bottom: 1px solid var(--border);
  font-size: .8125rem;
}
.scan-log-entry:last-child { border-bottom: none; }
.scan-log-needed   { color: var(--gold-light); }
.scan-log-skip     { color: var(--text-muted); }
.scan-log-icon     { flex-shrink: 0; }
.scan-log-qty      { margin-left: auto; font-family: var(--font-mono); font-weight: 700; }
.scan-status {
  max-width: 480px; margin: 0 auto 10px;
  font-size: .8rem; color: var(--text-muted);
  text-align: center; font-family: var(--font-mono);
  min-height: 18px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOBILE â€” iPhone 16 & alle schmalen Screens
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 768px) {

  /* Header kompakter */
  header {
    padding: 0 16px;
    height: 56px;
    gap: 12px;
  }
  .header-emblem { width: 36px; height: 36px; font-size: 16px; }
  .header-text h1 { font-size: 1rem; letter-spacing: .05em; }
  .header-text p  { display: none; }

  /* Layout: Sidebar Ã¼ber Main stapeln */
  .app {
    grid-template-columns: 1fr;
    grid-template-rows: auto 1fr;
    height: auto;
    min-height: calc(100vh - 56px);
  }

  /* Sidebar: horizontal scrollbar-frei, kompakt */
  .sidebar {
    border-right: none;
    border-bottom: 1px solid var(--border);
    padding: 16px;
    gap: 16px;
    overflow-y: visible;
  }

  /* Upload-Bereich: zwei Spalten nebeneinander */
  .upload-pair {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .drop-zone { min-height: 90px; }
  .dz-icon   { font-size: 1.4rem; }
  .dz-title  { font-size: .8125rem; }
  .dz-hint   { font-size: .6875rem; display: none; }

  /* Analyse-Button: volle Breite */
  #btn-run { width: 100%; }

  /* Main scrollt normal */
  .main { overflow-y: visible; }

  /* Result-Area: weniger Padding */
  .result-area { padding: 14px 12px; }

  /* Sektion-Nav */
  .sektion-nav { padding: 0 12px; gap: 4px; }
  .sektion-btn { padding: 10px 12px; font-size: .75rem; }

  /* Tabs: kleinere Schrift, weniger Padding */
  .tab { padding: 8px 6px; font-size: .6875rem; letter-spacing: .03em; }

  /* Set-Filter: horizontal scrollbar */
  .set-filter {
    flex-wrap: nowrap;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scroll-snap-type: x mandatory;
    padding-bottom: 6px;
    gap: 6px;
  }
  .set-btn {
    scroll-snap-align: start;
    flex-shrink: 0;
    min-width: 100px;
    max-width: 140px;
  }

  /* Filter-Bar: wraps gut, touch-freundliche Buttons */
  .filter-bar { gap: 6px 4px; padding: 8px 10px; }
  .ftog       { padding: 5px 8px; font-size: .75rem; min-height: 34px; }

  /* Tabelle: horizontaler Scroll */
  .table-wrap { border-radius: 0; margin: 0 -12px; }
  table { font-size: .8125rem; }
  th, td { padding: 8px 10px; }

  /* Suche + ZÃ¤hler */
  .search-row { flex-wrap: wrap; gap: 6px; }
  .search-input { font-size: 16px; /* verhindert iOS-Zoom */ }

  /* Ranking-Balken */
  .bar-cell { min-width: 80px; }

  /* Cache-Info */
  .cache-info { font-size: .75rem; padding: 8px 12px; }

  /* Diff-Banner */
  .diff-banner { flex-direction: column; gap: 8px; padding: 12px; }

  /* Scan-Panel: volle Breite */
  .scan-video-wrap { max-width: 100%; border-radius: 0; margin: 0 -12px 12px; }
  .scan-controls   { gap: 8px; }
  .scan-controls button { flex: 1; min-height: 44px; font-size: .875rem; }
  .scan-result     { max-width: 100%; border-radius: var(--radius); }
  .scan-log        { max-height: 180px; }
  .scan-log-entry  { font-size: .8125rem; padding: 8px 10px; }

  /* Touch-freundliche MindesthÃ¶he fÃ¼r alle klickbaren Elemente */
  button, .sektion-btn, .tab, .ftog, .set-btn { min-height: 38px; }
  .btn-primary, #btn-run { min-height: 48px; font-size: 1rem; }
}

@media (max-width: 400px) {
  /* iPhone SE / kleine GerÃ¤te */
  .tab { font-size: .625rem; padding: 7px 4px; }
  .sektion-btn { font-size: .6875rem; }
  .upload-pair { grid-template-columns: 1fr; }
}
</style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.0.4/tesseract.min.js"></script>
</head>
<body>

<!-- â•â• HEADER â•â• -->
<header role="banner">
  <div class="header-emblem" aria-hidden="true">âš”</div>
  <div class="header-text">
    <h1>Flesh &amp; Blood â€” Inventar-Bericht</h1>
    <p>Bestandsanalyse Â· lÃ¤uft vollstÃ¤ndig lokal im Browser Â· keine Daten werden Ã¼bertragen</p>
  </div>
</header>


<div class="app" role="main">

  <!-- â•â• SIDEBAR â•â• -->
  <aside class="sidebar" aria-label="Steuerung">

    <!-- Dateien -->
    <section aria-labelledby="lbl-dateien">
      <h2 class="section-heading" id="lbl-dateien">Dateien laden</h2>

      <div class="upload-pair">
      <div class="drop-zone" id="dz-karten" role="button" tabindex="0"
           aria-label="Kartenliste CSV hochladen"
           aria-describedby="st-karten"
           ondragover="dzOver(event,'dz-karten')"
           ondragleave="dzLeave('dz-karten')"
           ondrop="dzDrop(event,'karten')"
           onclick="this.querySelector('input').click();event.preventDefault()"
           onkeydown="if(event.key==='Enter'||event.key===' ')this.querySelector('input').click()">
        <input type="file" accept=".csv" aria-label="Kartenliste CSV auswÃ¤hlen"
               onchange="fileChosen(event,'karten')"
               onclick="event.stopPropagation()">
        <div class="dz-inner">
          <span class="dz-icon" aria-hidden="true">ğŸ“‹</span>
          <div class="dz-title">Kartenliste</div>
          <div class="dz-hint">VollstÃ¤ndige FaB-Karten CSV<br>hierher ziehen oder klicken</div>
          <div class="dz-status" id="st-karten" role="status" aria-live="polite"></div>
        </div>
      </div>

      <div id="cache-info-box" style="display:none;margin-top:10px"></div>
      <div style="height:12px"></div>

      <div class="drop-zone" id="dz-inv" role="button" tabindex="0"
           aria-label="Inventar CSV hochladen"
           aria-describedby="st-inv"
           ondragover="dzOver(event,'dz-inv')"
           ondragleave="dzLeave('dz-inv')"
           ondrop="dzDrop(event,'inv')"
           onclick="this.querySelector('input').click();event.preventDefault()"
           onkeydown="if(event.key==='Enter'||event.key===' ')this.querySelector('input').click()">
        <input type="file" accept=".csv" aria-label="Inventar CSV auswÃ¤hlen"
               onchange="fileChosen(event,'inv')"
               onclick="event.stopPropagation()">
        <div class="dz-inner">
          <span class="dz-icon" aria-hidden="true">ğŸ“¦</span>
          <div class="dz-title">Inventar</div>
          <div class="dz-hint">Aktueller Lagerbestand CSV<br>hierher ziehen oder klicken</div>
          <div class="dz-status" id="st-inv" role="status" aria-live="polite"></div>
        </div>
      </div>
      <div id="cache-info-box-inv" style="display:none;margin-top:10px"></div>

      </div>    </section>

    <hr class="gold-divider">

    <!-- Einstellungen -->
    <section aria-labelledby="lbl-config">
      <h2 class="section-heading" id="lbl-config">Einstellungen</h2>
      <div class="config-card">
        <div class="config-row">
          <label class="config-label" for="cfg-ziel">Ziel-Menge pro Karte</label>
          <input class="config-input" type="number" id="cfg-ziel"
                 value="20" min="1" max="999"
                 aria-describedby="cfg-ziel-hint">
        </div>
        <p id="cfg-ziel-hint" class="sr-only">Karten mit weniger als dieser Anzahl erscheinen im Bericht</p>
      </div>
    </section>

    <hr class="gold-divider">

    <!-- Analyse -->
    <section aria-labelledby="lbl-analyse">
      <h2 class="section-heading" id="lbl-analyse">Analyse</h2>
      <button class="btn btn-primary" id="btn-run" disabled
              onclick="runAnalyse()" aria-describedby="status-msg">
        âš” Analyse starten
      </button>
      <div class="status-msg" id="status-msg" role="status" aria-live="polite"
           style="margin-top:8px"></div>
    </section>

    <!-- Export -->
    <section aria-labelledby="lbl-export" style="margin-top:auto; padding-top:8px">
      <h2 class="section-heading" id="lbl-export">Export</h2>
      <button class="btn btn-secondary" id="btn-export" disabled onclick="exportXlsx()">
        â†“ Als Excel exportieren
      </button>
    </section>

  </aside>

  <!-- â•â• MAIN â•â• -->
  <main id="main" aria-label="Analyseergebnisse" aria-live="polite">
    <div class="empty-state">
      <div class="emblem" aria-hidden="true">âš”ï¸</div>
      <h2>Bereit zur Analyse</h2>
      <p>Kartenliste und Inventar hochladen, dann â€Analyse starten" klicken.<br>
         Alle Berechnungen laufen lokal â€” keine Daten verlassen den Browser.</p>
    </div>
  </main>

</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KONFIGURATION
//
//  Sets werden automatisch aus der Kartenliste erkannt.
//  Nur AusschlÃ¼sse und Metadaten mÃ¼ssen hier gepflegt werden.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Muster die AUSGESCHLOSSEN werden (Regex gegen den Set-Namen).
// Blitz Decks, Armory, History Packs, Promos usw.
const AUSSCHLUSS_MUSTER = [
  /blitz deck/i,
  /armory deck/i,
  /history pack/i,
  /promo/i,
  /demo deck/i,
  /hero deck/i,
  /starter deck/i,
  /classic battle/i,
  /tournament pack/i,
  /draft pack/i,
  /sealed deck/i,
  /welcome deck/i,
  /^token/i,
  /archive.*(pack|mastery)/i,
  /mastery pack/i,
  /first strike/i,
  /round the table/i,
  /slingshot/i,
  /smash palace/i,
  /gem pack/i,
  /convention exclusive/i,
];

// First-Edition-Sets (nicht mehr im Druck).
// Neue First-Ed Sets hier ergÃ¤nzen wenn LSS eines verÃ¶ffentlicht.
const FIRST_ED = new Set([
  'Welcome to Rathe - Alpha',
  'Arcane Rising - First',
  'Crucible of War - First',
  'Monarch - First',
  'Tales of Aria - First',
  'Everfest - First',
]);

// ZusammengehÃ¶rige Sets (First + Unlimited â†’ eine Gruppe).
// Neue Paare hier ergÃ¤nzen wenn nÃ¶tig.
const SET_GRUPPE = {
  'Welcome to Rathe - Alpha':             'Welcome to Rathe',
  'Welcome to Rathe - Unlimited':         'Welcome to Rathe',
  'Arcane Rising - First':                'Arcane Rising',
  'Arcane Rising - Unlimited':            'Arcane Rising',
  'Crucible of War - First':              'Crucible of War',
  'Crucible of War - Unlimited':          'Crucible of War',
  'Monarch - First':                      'Monarch',
  'Monarch - Unlimited':                  'Monarch',
  'Tales of Aria - First':                'Tales of Aria',
  'Tales of Aria - Unlimited':            'Tales of Aria',
  'Compendium Of Rathe':                  'Compendium of Rathe',
  'Compendium of Rathe - Antiquity Pack': 'Compendium of Rathe',
};

// Optionale Kurznamen fÃ¼r Set-Buttons (max ~12 Zeichen).
// Nicht eingetragene Sets bekommen einen auto-generierten Kurznamen.
const SET_SHORT_OVERRIDE = {
  'Welcome to Rathe - Alpha':             'WTR Alpha',
  'Welcome to Rathe - Unlimited':         'WTR Unlimited',
  'Arcane Rising - First':                'ARC First',
  'Arcane Rising - Unlimited':            'ARC Unlimited',
  'Crucible of War - First':              'CRU First',
  'Crucible of War - Unlimited':          'CRU Unlimited',
  'Monarch - First':                      'MON First',
  'Monarch - Unlimited':                  'MON Unlimited',
  'Tales of Aria - First':                'ELE First',
  'Tales of Aria - Unlimited':            'ELE Unlimited',
  'Everfest - First':                     'EVR First',
  'Compendium Of Rathe':                  'Compendium',
  'Compendium of Rathe - Antiquity Pack': 'COM Antiquity',
};

// Optionale Excel-Tab-Namen (max 31 Zeichen).
// Nicht eingetragene Sets bekommen einen auto-generierten Tab-Namen.
const SET_TABNAME_OVERRIDE = {
  'Welcome to Rathe - Alpha':             'WTR - Alpha',
  'Welcome to Rathe - Unlimited':         'WTR - Unlimited',
  'Arcane Rising - First':                'ARC - First',
  'Arcane Rising - Unlimited':            'ARC - Unlimited',
  'Crucible of War - First':              'CRU - First',
  'Crucible of War - Unlimited':          'CRU - Unlimited',
  'Monarch - First':                      'MON - First',
  'Monarch - Unlimited':                  'MON - Unlimited',
  'Tales of Aria - First':                'ELE - First',
  'Tales of Aria - Unlimited':            'ELE - Unlimited',
  'Everfest - First':                     'EVR - First',
  'Compendium Of Rathe':                  'Compendium of Rathe',
  'Compendium of Rathe - Antiquity Pack': 'Compendium - Antiquity',
};

// â”€â”€ Hilfsfunktionen fÃ¼r auto-generierte Namen â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setShort(name) {
  if (SET_SHORT_OVERRIDE[name]) return SET_SHORT_OVERRIDE[name];
  // KÃ¼rze bekannte Suffixe automatisch
  return name
    .replace(' - Unlimited', ' Unl.')
    .replace(' - First',     ' 1st')
    .replace(' - Alpha',     ' Alpha')
    .slice(0, 16);
}

function setTabName(name) {
  if (SET_TABNAME_OVERRIDE[name]) return SET_TABNAME_OVERRIDE[name];
  return name.slice(0, 31);
}

function istAusgeschlossen(setName) {
  return AUSSCHLUSS_MUSTER.some(p => p.test(setName));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FOIL-KLASSIFIZIERUNG
//  Jede Karte bekommt einen foilType: 'none'|'rainbow'|'cold'
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getFoilType(name) {
  if (!name) return 'none';
  // Cold Foil (inkl. Extended Art Cold Foil, Cold Foil Golden)
  if (/cold foil/i.test(name)) return 'cold';
  // Rainbow Foil (inkl. Extended Art Rainbow Foil, Alternate Art Rainbow Foil)
  if (/rainbow foil/i.test(name)) return 'rainbow';
  // Reverse Foil (selten, als eigene Gruppe)
  if (/reverse foil/i.test(name)) return 'cold';
  return 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SELTENHEITS-FARBEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RARITY_COLOR = {
  'Common':     'var(--common)',
  'Rare':       'var(--rare)',
  'Majestic':   'var(--majestic)',
  'Super Rare': 'var(--super-rare)',
  'Legendary':  'var(--legendary)',
  'Fabled':     'var(--fabled)',
  'Marvel':     'var(--marvel)',
  'Token':      'var(--text-muted)',
  'Promo':      'var(--promo)',
};
function rarityColor(r) { return RARITY_COLOR[r] || 'var(--text-dim)'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = {
  kartenCSV: null, invCSV: null, result: null,
  sektion:    'haupt',
  tab:        { haupt:'ranking', andere:'ranking' },
  activeSet:  { haupt:null,      andere:null      },
  search:     { haupt:'',        andere:''        },

  // Filter â€” Standard: Common+Rare aktiv, alle anderen aus, keine Foils
  f: {
    Common:     true,
    Rare:       true,
    Majestic:   false,
    'Super Rare': false,
    Legendary:  false,
    Fabled:     false,
    Marvel:     false,
    Token:      false,
    Promo:      false,
    rainbow:    false,   // Rainbow Foil ein/aus
    cold:       false,   // Cold Foil ein/aus
  },

  sortCol:     'fehlend_gesamt', sortDir:    -1,
  cardSortCol: 'name',           cardSortDir: 1,
  scan: { active: false, log: [] },  // Kartenerfassung
  diff: null,   // Differenzbericht: { ts, items: [{id, name, rarity, expansion, altQty, neuQty, delta}] }
  diffSortCol: 'delta', diffSortDir: -1,
  // Diff-eigene Filter â€” alle default true
  fd: {
    Common:true, Rare:true, Majestic:true, 'Super Rare':true,
    Legendary:true, Fabled:true, Marvel:true, Token:true, Promo:true,
    rainbow:true, cold:true,
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DRAG & DROP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function dzOver(e,id)       { e.preventDefault(); document.getElementById(id).classList.add('drag-over'); }
function dzLeave(id)        { document.getElementById(id).classList.remove('drag-over'); }
function dzDrop(e,type)     { e.preventDefault(); dzLeave(type==='karten'?'dz-karten':'dz-inv'); loadFile(e.dataTransfer.files[0],type); }
function fileChosen(e, type) {
  e.preventDefault();
  e.stopPropagation();
  const file = e.target.files && e.target.files[0];
  if (!file) return;
  loadFile(file, type);
  // Reset damit dieselbe Datei nochmal gewÃ¤hlt werden kann
  e.target.value = '';
}

function loadFile(file, type) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    const parsed = Papa.parse(ev.target.result, { header:true, skipEmptyLines:true });
    const dzId = type==='karten' ? 'dz-karten' : 'dz-inv';
    const stId = type==='karten' ? 'st-karten'  : 'st-inv';
    const dz = document.getElementById(dzId);
    const st = document.getElementById(stId);
    dz.classList.remove('loaded','errored');
    let err = null;
    if (type==='karten' && !parsed.data[0]?.expansion) err = 'âœ— Falsche Datei â€“ bitte die Kartenliste wÃ¤hlen';
    if (type==='inv'    && !parsed.data[0]?.quantity)  err = 'âœ— Falsche Datei â€“ bitte das Inventar wÃ¤hlen';
    if (err) { dz.classList.add('errored'); st.className='dz-status err'; st.textContent=err; return; }
    dz.classList.add('loaded');
    st.className='dz-status ok';
    st.textContent = 'âœ“ ' + file.name + '  (' + parsed.data.length.toLocaleString('de') + ' Zeilen)';
    if (type==='karten') {
      S.kartenCSV = parsed.data;
      // Kartenliste im localStorage cachen
      try {
        const meta = { name: file.name, rows: parsed.data.length, ts: Date.now() };
        localStorage.setItem('fab_karten_meta', JSON.stringify(meta));
        localStorage.setItem('fab_karten_csv',  ev.target.result);
        renderCacheInfo();
      } catch(e) { /* localStorage voll oder deaktiviert */ }
    } else {
      // Differenzbericht: altes Inventar mit neuem vergleichen
      if (S.invCSV && S.kartenCSV) {
        berechneDiff(S.invCSV, parsed.data);
      } else {
        S.diff = null;
      }
      S.invCSV = parsed.data;
      try {
        const meta = { name: file.name, rows: parsed.data.length, ts: Date.now() };
        localStorage.setItem('fab_inv_meta', JSON.stringify(meta));
        localStorage.setItem('fab_inv_csv',  ev.target.result);
        renderInvCacheInfo();
      } catch(e) {}
    }
    document.getElementById('btn-run').disabled = !(S.kartenCSV && S.invCSV);
  };
  reader.readAsText(file, 'UTF-8');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOCALSTORAGE â€” Kartenliste cachen
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LS_META = 'fab_karten_meta';
const LS_CSV  = 'fab_karten_csv';

function ladeKartenAusCache() {
  try {
    const meta = JSON.parse(localStorage.getItem(LS_META) || 'null');
    const csv  = localStorage.getItem(LS_CSV);
    if (!meta || !csv) return false;

    const parsed = Papa.parse(csv, { header:true, skipEmptyLines:true });
    if (!parsed.data[0]?.expansion) return false;

    S.kartenCSV = parsed.data;

    // Drop-Zone als geladen markieren
    const dz = document.getElementById('dz-karten');
    const st = document.getElementById('st-karten');
    if (dz) dz.classList.add('loaded');
    if (st) {
      st.className = 'dz-status ok';
      st.textContent = 'âœ“ ' + meta.name + '  (' + parsed.data.length.toLocaleString('de') + ' Zeilen)';
    }
    document.getElementById('btn-run').disabled = !(S.kartenCSV && S.invCSV);
    renderCacheInfo();
    return true;
  } catch(e) {
    return false;
  }
}

function renderCacheInfo() {
  const box  = document.getElementById('cache-info-box');
  const meta = (() => { try { return JSON.parse(localStorage.getItem(LS_META) || 'null'); } catch(e) { return null; } })();
  if (!box || !meta) { if (box) box.style.display = 'none'; return; }

  const ts   = new Date(meta.ts);
  const date = ts.toLocaleDateString('de-DE', { day:'2-digit', month:'2-digit', year:'numeric' });
  const time = ts.toLocaleTimeString('de-DE', { hour:'2-digit', minute:'2-digit' });

  box.style.display = 'block';
  box.innerHTML =
    '<div class="cache-info">' +
      '<div class="cache-info-text">' +
        '<strong>Kartenliste gecacht</strong>' +
        date + ' ' + time + ' &middot; ' + meta.rows.toLocaleString('de') + ' Karten' +
      '</div>' +
      '<button class="btn-cache-clear" onclick="clearKartenCache()" title="Kartenliste aus Cache lÃ¶schen">âœ• LÃ¶schen</button>' +
    '</div>';
}

function clearKartenCache() {
  try {
    localStorage.removeItem(LS_META);
    localStorage.removeItem(LS_CSV);
  } catch(e) {}
  S.kartenCSV = null;
  const dz = document.getElementById('dz-karten');
  const st = document.getElementById('st-karten');
  if (dz) dz.classList.remove('loaded','errored');
  if (st) { st.className='dz-status'; st.textContent=''; }
  const box = document.getElementById('cache-info-box');
  if (box) box.style.display = 'none';
  document.getElementById('btn-run').disabled = true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOCALSTORAGE â€” Inventar cachen
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LS_INV_META = 'fab_inv_meta';
const LS_INV_CSV  = 'fab_inv_csv';

function ladeInvAusCache() {
  try {
    const meta = JSON.parse(localStorage.getItem(LS_INV_META) || 'null');
    const csv  = localStorage.getItem(LS_INV_CSV);
    if (!meta || !csv) return false;

    const parsed = Papa.parse(csv, { header:true, skipEmptyLines:true });
    if (!parsed.data[0]?.quantity) return false;

    S.invCSV = parsed.data;

    const dz = document.getElementById('dz-inv');
    const st = document.getElementById('st-inv');
    if (dz) dz.classList.add('loaded');
    if (st) {
      st.className = 'dz-status ok';
      st.textContent = 'âœ“ ' + meta.name + '  (' + parsed.data.length.toLocaleString('de') + ' Zeilen)';
    }
    document.getElementById('btn-run').disabled = !S.kartenCSV;
    renderInvCacheInfo();
    return true;
  } catch(e) {
    return false;
  }
}

function renderInvCacheInfo() {
  const box  = document.getElementById('cache-info-box-inv');
  const meta = (() => { try { return JSON.parse(localStorage.getItem(LS_INV_META) || 'null'); } catch(e) { return null; } })();
  if (!box || !meta) { if (box) box.style.display = 'none'; return; }

  const ts   = new Date(meta.ts);
  const date = ts.toLocaleDateString('de-DE', { day:'2-digit', month:'2-digit', year:'numeric' });
  const time = ts.toLocaleTimeString('de-DE', { hour:'2-digit', minute:'2-digit' });

  // Alter berechnen
  const ageMs  = Date.now() - meta.ts;
  const ageDays = Math.floor(ageMs / 86400000);
  const ageHrs  = Math.floor(ageMs / 3600000);
  const ageStr  = ageDays >= 2 ? ageDays + ' Tage alt'
                : ageDays === 1 ? '1 Tag alt'
                : ageHrs >= 1  ? ageHrs + ' Std. alt'
                : 'gerade eben';

  const warn = ageDays >= 7;  // Warnung wenn Ã¤lter als 7 Tage

  box.style.display = 'block';
  box.innerHTML =
    '<div class="cache-info' + (warn ? ' cache-info-warn' : '') + '">' +
      '<div class="cache-info-text">' +
        '<strong>Inventar gecacht</strong>' +
        date + ' ' + time + ' &middot; ' + meta.rows.toLocaleString('de') + ' Artikel' +
        (warn ? '<br><span style="color:var(--majestic)">âš  ' + ageStr + ' â€“ aktualisieren?</span>' : ' &middot; ' + ageStr) +
      '</div>' +
      '<button class="btn-cache-clear" onclick="clearInvCache()" title="Inventar aus Cache lÃ¶schen">âœ•</button>' +
    '</div>';
}

function clearInvCache() {
  try {
    localStorage.removeItem(LS_INV_META);
    localStorage.removeItem(LS_INV_CSV);
  } catch(e) {}
  S.invCSV = null;
  const dz = document.getElementById('dz-inv');
  const st = document.getElementById('st-inv');
  if (dz) dz.classList.remove('loaded','errored');
  if (st) { st.className='dz-status'; st.textContent=''; }
  const box = document.getElementById('cache-info-box-inv');
  if (box) box.style.display = 'none';
  document.getElementById('btn-run').disabled = true;
}

// Cache beim Seitenstart laden
(function() {
  try { ladeKartenAusCache(); } catch(e) {}
  try { ladeInvAusCache();    } catch(e) {}
  // btn-run Status nach beiden Caches aktualisieren
  document.getElementById('btn-run').disabled = !(S.kartenCSV && S.invCSV);
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KARTENFARBE (Pitch-Farbe aus Klammerausdruck)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getDotColor(name) {
  const m = name && name.match(/\(([^)]+)\)/);
  if (!m) return 'var(--c-neutral)';
  const v = m[1].toLowerCase().trim();
  if (v === 'red')                       return 'var(--c-red)';
  if (v === 'yellow' || v === 'yelllow') return 'var(--c-yellow)';
  if (v === 'blue'   || v === 'bleu')    return 'var(--c-blue)';
  return 'var(--c-neutral)';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ANALYSE â€” Gruppe analysieren (alle Seltenheiten, alle Foils)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function analysiereGruppe(sets, ziel, invMap) {
  // Alle Karten dieser Sets, OHNE jeglichen Filter â€”
  // Filterung passiert erst beim Anzeigen.
  const karten = S.kartenCSV.filter(r => sets.has(r.expansion) && r.name && r.cardmarketId);

  const fehlend   = [];
  const setGesamt = {};   // {expansion: {total, byRarity, byFoil}}

  karten.forEach(k => {
    const id      = parseInt(k.cardmarketId);
    const qty     = invMap.get(id) || 0;
    const foilTyp = getFoilType(k.name);

    // Statistiken pro Set aufbauen (ungefiltert, fÃ¼r Ranking-Tabelle)
    if (!setGesamt[k.expansion]) setGesamt[k.expansion] = { total: 0 };
    setGesamt[k.expansion].total++;

    if (qty < ziel) {
      fehlend.push({
        id, name: k.name, rarity: k.rarity, foilType: foilTyp,
        expansion: k.expansion, expansionCode: k.expansionCode,
        collectorNumber: k.collectorNumber || '',
        im_inv: qty, fehlend: ziel - qty,
      });
    }
  });

  // Ranking: basierend auf ungefilterten Fehlmengen
  // (damit das Ranking stabil bleibt egal welche Filter aktiv sind)
  const rankMap = {};
  fehlend.forEach(k => {
    if (!rankMap[k.expansion]) rankMap[k.expansion] = { verschiedene:0, fehlend_gesamt:0, null_stueck:0 };
    rankMap[k.expansion].verschiedene++;
    rankMap[k.expansion].fehlend_gesamt += k.fehlend;
    if (k.im_inv===0) rankMap[k.expansion].null_stueck++;
  });

  const ranking = Object.entries(rankMap).map(([set,d]) => ({
    expansion: set, gruppe: SET_GRUPPE[set]||set, first_ed: FIRST_ED.has(set),
    gesamt: setGesamt[set]?.total || 0, ...d,
    fehlquote: setGesamt[set]?.total ? +(d.verschiedene / setGesamt[set].total * 100).toFixed(1) : 0,
  }));
  ranking.sort((a,b) => b.fehlend_gesamt - a.fehlend_gesamt);

  const setsData = {};
  fehlend.forEach(k => { (setsData[k.expansion] = setsData[k.expansion]||[]).push(k); });

  // Stats: immer Common+Rare ohne Foil als Basisreferenz
  const basis = fehlend.filter(k => (k.rarity==='Common'||k.rarity==='Rare') && k.foilType==='none');
  return {
    ranking, setsData, allFehlend: fehlend,
    stats: {
      gesamt:  basis.length,
      common:  basis.filter(k=>k.rarity==='Common').length,
      rare:    basis.filter(k=>k.rarity==='Rare').length,
      null:    basis.filter(k=>k.im_inv===0).length,
    },
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ANALYSE â€” Einstiegspunkt
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runAnalyse() {
  const ziel = parseInt(document.getElementById('cfg-ziel').value) || 20;
  const sm   = document.getElementById('status-msg');
  sm.className = 'status-msg running';
  sm.innerHTML = '<span class="spinner" aria-hidden="true"></span>Analysiereâ€¦';
  document.getElementById('btn-run').disabled    = true;
  document.getElementById('btn-export').disabled = true;

  setTimeout(() => {
    try {
      const alleExpansions = [...new Set(S.kartenCSV.map(r => r.expansion).filter(Boolean))];
      const hauptsets  = new Set(alleExpansions.filter(s => !istAusgeschlossen(s)));
      const anderesets = new Set(alleExpansions.filter(s =>  istAusgeschlossen(s)));

      // Inventar summieren (inkl. Foils â€” alle Varianten eines cardmarketId werden summiert)
      const invMap = new Map();
      S.invCSV.forEach(r => {
        const id  = parseInt(r.cardmarketId);
        const qty = parseInt(r.quantity) || 0;
        if (!isNaN(id)) invMap.set(id, (invMap.get(id)||0) + qty);
      });

      const haupt  = analysiereGruppe(hauptsets,  ziel, invMap);
      const andere = analysiereGruppe(anderesets, ziel, invMap);

      S.result    = { ziel, haupt, andere };
      S.sektion   = 'haupt';
      S.tab       = { haupt:'ranking', andere:'ranking' };
      S.activeSet = { haupt:null,      andere:null      };
      S.search    = { haupt:'',        andere:''        };

      const gesamt = haupt.stats.gesamt + andere.stats.gesamt;
      sm.className = 'status-msg done';
      sm.textContent = 'âœ“ ' + gesamt.toLocaleString('de') + ' fehlende C/R Â· '
        + hauptsets.size + ' Hauptsets Â· ' + anderesets.size + ' andere Produkte';
      document.getElementById('btn-run').disabled    = false;
      document.getElementById('btn-export').disabled = false;
      render();
    } catch(err) {
      sm.className = 'status-msg err';
      sm.textContent = 'âœ— Fehler: ' + err.message;
      document.getElementById('btn-run').disabled = false;
      console.error(err);
    }
  }, 30);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILTER â€” Karten fÃ¼r Anzeige filtern
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function filterKarten(cards) {
  return cards.filter(card => {
    // Foil-Filter zuerst
    if (card.foilType === 'rainbow' && !S.f.rainbow) return false;
    if (card.foilType === 'cold'    && !S.f.cold)    return false;
    // Seltenheits-Filter (nur wenn es keine Foil ist, oder Foil aktiv)
    const rarKey = card.rarity;
    if (!(rarKey in S.f)) return false;   // unbekannte Seltenheit: ignorieren
    return S.f[rarKey];
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER â€” Hilfsfunktionen
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function renderStats(st) {
  return '<div class="stats-row" role="list" aria-label="Ãœbersicht (Common + Rare, kein Foil)">' +
    '<div class="stat-card s-total" role="listitem"><div class="stat-val">' + st.gesamt.toLocaleString('de') + '</div><div class="stat-lbl">C/R fehlend</div></div>' +
    '<div class="stat-card s-common" role="listitem"><div class="stat-val">' + st.common.toLocaleString('de') + '</div><div class="stat-lbl">Common</div></div>' +
    '<div class="stat-card s-rare" role="listitem"><div class="stat-val">' + st.rare.toLocaleString('de') + '</div><div class="stat-lbl">Rare</div></div>' +
    '<div class="stat-card s-null" role="listitem"><div class="stat-val">' + st.null.toLocaleString('de') + '</div><div class="stat-lbl">Davon 0Ã—</div></div>' +
  '</div>';
}

function alleRarAn(fObj) {
  const RARITAETEN = ['Common','Rare','Majestic','Super Rare','Legendary','Fabled','Marvel','Token','Promo'];
  return RARITAETEN.every(r => fObj[r]);
}
function toggleAlleRar(fKey) {
  const RARITAETEN = ['Common','Rare','Majestic','Super Rare','Legendary','Fabled','Marvel','Token','Promo'];
  const allOn = alleRarAn(S[fKey]);
  RARITAETEN.forEach(r => S[fKey][r] = !allOn);
  render();
}
function renderFilterBar(sektion) {
  const RARITAETEN = ['Common','Rare','Majestic','Super Rare','Legendary','Fabled','Marvel','Token','Promo'];
  const allOn  = alleRarAn(S.f);
  const alleRarBtn = '<button class="ftog' + (allOn ? ' on' : '') + '" style="--fcol:var(--gold)"' +
    ' aria-pressed="' + allOn + '" onclick="toggleAlleRar(\'f\')">Alle</button>';
  const rarBtns = RARITAETEN.map(r => {
    const on  = S.f[r] ? ' on' : '';
    const col = RARITY_COLOR[r] || 'var(--text-dim)';
    return '<button class="ftog' + on + '" style="--fcol:' + col + '"' +
      ' aria-pressed="' + S.f[r] + '"' +
      ' onclick="toggleFilter(\'' + r + '\')">' + esc(r) + '</button>';
  }).join('');

  const rfOn  = S.f.rainbow ? ' on foil-rf' : ' foil-rf';
  const cfOn  = S.f.cold    ? ' on foil-cf' : ' foil-cf';

  return '<div class="filter-bar" role="group" aria-label="Karten filtern">' +
    '<span class="filter-label">Seltenheit</span>' +
    '<div class="filter-group">' + alleRarBtn + rarBtns + '</div>' +
    '<span class="filter-sep"></span>' +
    '<span class="filter-label">Foil</span>' +
    '<div class="filter-group">' +
      '<button class="ftog' + rfOn + '" aria-pressed="' + S.f.rainbow + '" onclick="toggleFilter(\'rainbow\')">Rainbow Foil</button>' +
      '<button class="ftog' + cfOn + '" aria-pressed="' + S.f.cold    + '" onclick="toggleFilter(\'cold\')">Cold Foil</button>' +
    '</div>' +
  '</div>';
}

function renderRankingPanel(data, sektion) {
  const maxF = Math.max(...data.ranking.map(x=>x.fehlend_gesamt), 1);
  const cols = [
    { key:'expansion',      label:'Set',                  num:false },
    { key:'gesamt',         label:'Karten gesamt',        num:true  },
    { key:'verschiedene',   label:'Verschiedene fehlend', num:true  },
    { key:'null_stueck',    label:'Davon 0Ã—',             num:true  },
    { key:'fehlend_gesamt', label:'Fehlende StÃ¼ck',       num:false },
    { key:'fehlquote',      label:'Fehlquote',            num:true  },
  ];
  const thead = cols.map(col => {
    const s = S.sortCol===col.key;
    const arr = s ? (S.sortDir===-1?'â–¼':'â–²') : 'â–²';
    return '<th class="' + (col.num?'num ':'') + (s?'sorted':'') + '" onclick="sortRanking(\'' + col.key + '\')" scope="col" aria-sort="' + (s?(S.sortDir===-1?'descending':'ascending'):'none') + '">' +
      esc(col.label) + ' <span class="sort-arrow" aria-hidden="true">' + arr + '</span></th>';
  }).join('');

  const sorted = [...data.ranking].sort((a,b) => S.sortDir*(
    typeof a[S.sortCol]==='string' ? a[S.sortCol].localeCompare(b[S.sortCol]) : (a[S.sortCol]-b[S.sortCol])
  ));

  const rows = sorted.map((row,i) => {
    const barW = Math.round(row.fehlend_gesamt/maxF*90);
    const fe   = row.first_ed ? '<span class="badge-fe">1st Ed</span>' : '';
    const grp  = SET_GRUPPE[row.expansion];
    const lbl  = (grp && grp!==row.expansion)
      ? '<span style="color:var(--text-muted);font-size:.8125rem">' + esc(grp) + ' / </span>' + esc(row.expansion.replace(/- (First|Unlimited|Alpha)/,'').trim())
      : esc(row.expansion);
    const exp  = row.expansion.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
    return '<tr onclick="goToSet(\'' + exp + '\',\'' + sektion + '\')" style="cursor:pointer" tabindex="0" role="row"' +
      ' onkeydown="if(event.key===\'Enter\')goToSet(\'' + exp + '\',\'' + sektion + '\')">' +
      '<td><span class="rank-num" aria-hidden="true">' + (i+1) + '</span>' + lbl + fe + '</td>' +
      '<td class="num">' + row.gesamt + '</td>' +
      '<td class="num">' + row.verschiedene + '</td>' +
      '<td class="num" style="color:var(--danger)">' + row.null_stueck + '</td>' +
      '<td><div class="bar-cell"><div class="bar-bg" aria-hidden="true"><div class="bar-fill" style="width:' + barW + 'px"></div></div>' +
        '<span class="bar-val">' + row.fehlend_gesamt.toLocaleString('de') + '</span></div></td>' +
      '<td class="num">' + row.fehlquote + '%</td></tr>';
  }).join('');

  return '<div class="table-wrap"><table aria-label="Set-Ranking"><thead><tr>' + thead + '</tr></thead><tbody>' + rows + '</tbody></table></div>' +
    '<p style="margin-top:10px;font-family:var(--font-mono);font-size:.75rem;color:var(--text-muted)">Zeile anklicken um Kartendetails zu Ã¶ffnen Â· SpaltenkÃ¶pfe zum Sortieren</p>';
}

function renderKartenRow(card, ziel, extraSet) {
  const pct  = Math.min(100, Math.round(card.im_inv/ziel*100));
  const zero = card.im_inv===0 ? '<span class="zero-badge">0Ã—</span>' : '';
  const foilTag = card.foilType==='rainbow' ? '<span class="foil-tag rf" title="Rainbow Foil">RF</span>' :
                  card.foilType==='cold'    ? '<span class="foil-tag cf" title="Cold Foil">CF</span>' : '';
  const setCell = extraSet ? '<td style="color:var(--text-dim);font-size:.8rem">' + esc(card.expansion||'â€“') + '</td>' : '';
  return '<tr>' +
    '<td><span class="dot" style="background:' + getDotColor(card.name) + '" aria-hidden="true"></span>' +
    foilTag + esc(card.name) + '</td>' +
    '<td style="color:' + rarityColor(card.rarity) + ';font-weight:600">' + esc(card.rarity) + '</td>' +
    setCell +
    '<td><div class="prog-cell">' + zero +
      '<div class="prog-bg" aria-hidden="true"><div class="prog-fill" style="width:' + pct + '%"></div></div>' +
      '<span class="prog-txt">' + card.im_inv + ' / ' + ziel + '</span></div></td>' +
    '<td class="num" style="color:var(--gold-light);font-weight:600">' + card.fehlend + '</td></tr>';
}

function buildKartenTable(cards, sektion, search, extraSet) {
  const baseCols = [
    { key:'name',    label:'Kartenname', num:false },
    { key:'rarity',  label:'Seltenheit', num:false },
  ];
  const midCols  = extraSet ? [{ key:'expansion', label:'Set', num:false }] : [];
  const endCols  = [
    { key:'im_inv',  label:'Im Inventar', num:true },
    { key:'fehlend', label:'Fehlend',     num:true },
  ];
  const cCols = [...baseCols, ...midCols, ...endCols];
  const thead = cCols.map(col => {
    const s   = S.cardSortCol===col.key;
    const arr = s ? (S.cardSortDir===1?'â–²':'â–¼') : 'â–²';
    return '<th class="' + (col.num?'num ':'') + (s?'sorted':'') + '"' +
      ' onclick="sortCards(\'' + col.key + '\')" scope="col"' +
      ' aria-sort="' + (s?(S.cardSortDir===1?'ascending':'descending'):'none') + '">' +
      esc(col.label) + ' <span class="sort-arrow" aria-hidden="true">' + arr + '</span></th>';
  }).join('');
  const ziel  = S.result.ziel;
  const tbody = cards.map(card => renderKartenRow(card, ziel, extraSet)).join('');
  return '<div class="search-row">' +
      '<input class="search-input" type="search" placeholder="Kartenname suchenâ€¦" value="' + esc(search) + '"' +
        ' aria-label="Kartenname suchen" oninput="S.search[\'' + sektion + '\']=this.value;render()">' +
      '<span class="count-lbl" aria-live="polite">' + cards.length.toLocaleString('de') + ' Karten</span>' +
    '</div>' +
    '<div class="table-wrap"><table aria-label="Fehlende Karten">' +
      '<thead><tr>' + thead + '</tr></thead><tbody>' + tbody + '</tbody></table></div>';
}

function fehlendFuerSet(cards) {
  if (!cards) return 0;
  return cards
    .filter(card => {
      if (card.foilType === 'rainbow' && !S.f.rainbow) return false;
      if (card.foilType === 'cold'    && !S.f.cold)    return false;
      if (!(card.rarity in S.f)) return false;
      return S.f[card.rarity];
    })
    .reduce((s, card) => s + card.fehlend, 0);
}

function renderKartenPanel(data, sektion) {
  const activeSet = S.activeSet[sektion];
  const search    = S.search[sektion];
  const alleAktiv = activeSet === '__alle__';

  // "Alle"-Button immer ganz links
  const alleBtn =
    '<button class="set-btn' + (alleAktiv ? ' active' : '') + '"' +
    ' onclick="selectSet(\'__alle__\',\'' + sektion + '\')"' +
    ' aria-pressed="' + alleAktiv + '">' +
    '<span class="set-btn-name">Alle</span>' +
    '<span class="set-btn-count">alle Sets</span>' +
    '</button>';

  // Set-Buttons nur anzeigen wenn "Alle" NICHT aktiv
  const setBtns = data.ranking.map(row => {
    const fe     = row.first_ed ? ' fe' : '';
    const active = activeSet===row.expansion ? ' active' : '';
    const exp    = row.expansion.replace(/\\/g,'\\\\').replace(/'/g,"\'");
    return '<button class="set-btn' + fe + active + '"' +
      ' onclick="selectSet(\'' + exp + '\',\'' + sektion + '\')"' +
      ' aria-pressed="' + (activeSet===row.expansion) + '">' +
      '<span class="set-btn-name">' + esc(row.expansion) + '</span>' +
      '<span class="set-btn-count">' + fehlendFuerSet(data.setsData[row.expansion]) + ' fehlend</span>' +
      '</button>';
  }).join('');

  const filterBar = renderFilterBar(sektion);
  let tableHtml   = '<p style="color:var(--text-muted);padding:32px;text-align:center;font-size:.9375rem">Set oben auswÃ¤hlen um die fehlenden Karten anzuzeigen</p>';

  if (alleAktiv) {
    let cards = [];
    data.ranking.forEach(row => {
      (data.setsData[row.expansion]||[]).forEach(card => {
        cards.push(Object.assign({}, card, { expansion: row.expansion }));
      });
    });
    cards = filterKarten(cards);
    if (search) { const q=search.toLowerCase(); cards=cards.filter(c=>c.name.toLowerCase().includes(q)); }
    cards.sort((a,b) => { const av=a[S.cardSortCol],bv=b[S.cardSortCol]; return S.cardSortDir*(typeof av==='string'?av.localeCompare(bv):(av-bv)); });
    tableHtml = buildKartenTable(cards, sektion, search, true);

  } else if (activeSet && data.setsData[activeSet]) {
    let cards = filterKarten(data.setsData[activeSet]);
    if (search) { const q=search.toLowerCase(); cards=cards.filter(c=>c.name.toLowerCase().includes(q)); }
    cards.sort((a,b) => { const av=a[S.cardSortCol],bv=b[S.cardSortCol]; return S.cardSortDir*(typeof av==='string'?av.localeCompare(bv):(av-bv)); });
    tableHtml = buildKartenTable(cards, sektion, search, false);
  }

  return '<div class="set-filter" role="group" aria-label="Set auswÃ¤hlen">' + alleBtn + setBtns + '</div>' + filterBar + tableHtml;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER â€” Haupt
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
  if (!S.result) return;
  const r    = S.result;
  const sek  = S.sektion;
  const data = r[sek];
  const tab  = S.tab[sek];

  const sektionNav =
    '<nav class="sektion-nav" aria-label="Kategorie wechseln">' +
      '<button class="sektion-btn ' + (sek==='haupt'?'active':'') + '"' +
        ' onclick="wechseSektion(\'haupt\')" aria-pressed="' + (sek==='haupt') + '">' +
        'Hauptsets <span class="s-badge">' + r.haupt.ranking.length + '</span></button>' +
      '<button class="sektion-btn ' + (sek==='andere'?'active':'') + '"' +
        ' onclick="wechseSektion(\'andere\')" aria-pressed="' + (sek==='andere') + '">' +
        'Andere Produkte <span class="s-badge">' + r.andere.ranking.length + '</span></button>' +
    '</nav>';

  const hasDiff = !!S.diff;
  const subTabs =
    '<div class="tabs" role="tablist" aria-label="Ansicht wechseln">' +
      '<button class="tab ' + (tab==='ranking'?'active':'') + '" role="tab" aria-selected="' + (tab==='ranking') + '" onclick="switchTab(\'ranking\')">ğŸ“Š Set-Ranking</button>' +
      '<button class="tab ' + (tab==='karten'?'active':'') + '" role="tab" aria-selected="' + (tab==='karten') + '" onclick="switchTab(\'karten\')">ğŸƒ Kartendetails</button>' +
      (hasDiff ? '<button class="tab ' + (tab==='diff'?'active':'') + '" role="tab" aria-selected="' + (tab==='diff') + '" onclick="switchTab(\'diff\')">ğŸ“‰ VerkÃ¤ufe</button>' : '') +
      '<button class="tab ' + (tab==='scan'?'active':'') + '" role="tab" aria-selected="' + (tab==='scan') + '" onclick="switchTab(\'scan\')">ğŸ“· Kartenerfassung</button>' +
    '</div>';

  let panelContent = '';
  if (tab === 'ranking') panelContent = renderRankingPanel(data, sek);
  if (tab === 'karten')  panelContent = renderKartenPanel(data, sek);
  if (tab === 'diff')    panelContent = renderDiffPanel();
  if (tab === 'scan')    panelContent = renderScanPanel();

  document.getElementById('main').innerHTML =
    sektionNav +
    '<div class="result-area">' +
      subTabs +
      panelContent +
    '</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INTERAKTIONEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function wechseSektion(sek) {
  S.sektion = sek;
  S.sortCol = 'fehlend_gesamt'; S.sortDir = -1;
  S.cardSortCol = 'name'; S.cardSortDir = 1;
  render();
}
function switchTab(t) {
  if (S.tab[S.sektion] === 'scan' && t !== 'scan') stopScan();
  S.tab[S.sektion] = t;
  S.activeSet[S.sektion] = null;
  S.search[S.sektion] = '';
  render();
}
function selectSet(s, sek) {
  S.sektion = sek;
  S.tab[sek] = 'karten';
  S.activeSet[sek] = s;
  S.search[sek] = '';
  render();
}
function goToSet(s, sek)  { selectSet(s, sek); }
function sortRanking(col) { S.sortDir = S.sortCol===col ? -S.sortDir : -1; S.sortCol=col; render(); }
function sortCards(col)   { S.cardSortDir = S.cardSortCol===col ? -S.cardSortDir : 1; S.cardSortCol=col; render(); }
function toggleFilter(key){ S.f[key] = !S.f[key]; render(); }
function toggleDiffFilter(key){ S.fd[key] = !S.fd[key]; render(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DIFFERENZBERICHT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function berechneDiff(altInvCSV, neuInvCSV) {
  // Menge je cardmarketId aufbauen
  function invMap(rows) {
    const m = new Map();
    rows.forEach(r => {
      const id  = r.idProduct || r.cardmarketId || r['Product ID'] || r.id;
      const qty = parseInt(r.quantity || r.Quantity || r.count || 0, 10);
      if (id && !isNaN(qty)) m.set(String(id), qty);
    });
    return m;
  }

  const altMap = invMap(altInvCSV);
  const neuMap = invMap(neuInvCSV);

  // Kartenliste fÃ¼r Metadaten (Name, Seltenheit, Set)
  const kartenMeta = new Map();
  if (S.kartenCSV) {
    S.kartenCSV.forEach(r => {
      if (r.cardmarketId) kartenMeta.set(String(r.cardmarketId), r);
    });
  }

  const items = [];
  // Alle IDs die im alten Inventar waren
  altMap.forEach((altQty, id) => {
    const neuQty = neuMap.get(id) || 0;
    const delta  = altQty - neuQty;   // positiv = verkauft
    if (delta > 0) {
      const meta = kartenMeta.get(id) || {};
      items.push({
        id,
        name:       meta.name       || id,
        rarity:     meta.rarity     || 'â€“',
        expansion:  meta.expansion  || 'â€“',
        foilType:   getFoilType(meta.name || ''),
        collectorNumber: meta.collectorNumber || '',
        altQty, neuQty, delta,
      });
    }
  });

  if (items.length === 0) {
    S.diff = null;
    return;
  }

  S.diff = { ts: Date.now(), items };
}

function sortDiff(col) {
  if (S.diffSortCol === col) S.diffSortDir = -S.diffSortDir;
  else { S.diffSortCol = col; S.diffSortDir = col === 'delta' ? -1 : 1; }
  render();
}

function renderDiffPanel() {
  if (!S.diff) return '<p style="color:var(--text-muted);padding:24px">Kein Differenzbericht verfÃ¼gbar.</p>';

  const { ts, items: allItems } = S.diff;

  // Diff-Filterleiste bauen
  const RARITAETEN = ['Common','Rare','Majestic','Super Rare','Legendary','Fabled','Marvel','Token','Promo'];
  const alleDiffOn = alleRarAn(S.fd);
  const alleDiffBtn = '<button class="ftog' + (alleDiffOn ? ' on' : '') + '" style="--fcol:var(--gold)"' +
    ' aria-pressed="' + alleDiffOn + '" onclick="toggleAlleRar(\'fd\')">Alle</button>';
  const rarBtns = RARITAETEN.map(r => {
    const on  = S.fd[r] ? ' on' : '';
    const col = RARITY_COLOR[r] || 'var(--text-dim)';
    return '<button class="ftog' + on + '" style="--fcol:' + col + '"' +
      ' aria-pressed="' + S.fd[r] + '"' +
      ' onclick="toggleDiffFilter(\'' + r + '\')">' + esc(r) + '</button>';
  }).join('');
  const rfOn = S.fd.rainbow ? ' on foil-rf' : ' foil-rf';
  const cfOn = S.fd.cold    ? ' on foil-cf' : ' foil-cf';
  const diffFilterBar =
    '<div class="filter-bar" role="group" aria-label="VerkÃ¤ufe filtern">' +
    '<span class="filter-label">Seltenheit</span>' +
    '<div class="filter-group">' + alleDiffBtn + rarBtns + '</div>' +
    '<span class="filter-sep"></span>' +
    '<span class="filter-label">Foil</span>' +
    '<div class="filter-group">' +
      '<button class="ftog' + rfOn + '" aria-pressed="' + S.fd.rainbow + '" onclick="toggleDiffFilter(\'rainbow\')">Rainbow Foil</button>' +
      '<button class="ftog' + cfOn + '" aria-pressed="' + S.fd.cold    + '" onclick="toggleDiffFilter(\'cold\')">Cold Foil</button>' +
    '</div></div>';

  // Filtern
  const items = allItems.filter(item => {
    if (item.foilType === 'rainbow' && !S.fd.rainbow) return false;
    if (item.foilType === 'cold'    && !S.fd.cold)    return false;
    if (!(item.rarity in S.fd)) return true;
    return S.fd[item.rarity];
  });

  const tsStr = new Date(ts).toLocaleString('de-DE', {
    day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'
  });
  const totalSold  = items.reduce((s,i) => s+i.delta, 0);
  const totalCards = items.length;

  // Sortieren
  const sorted = [...items].sort((a,b) => {
    const av = a[S.diffSortCol], bv = b[S.diffSortCol];
    return S.diffSortDir * (typeof av === 'string' ? av.localeCompare(bv) : (av - bv));
  });

  // Set-Ranking (wieviel je Set verkauft)
  const setMap = new Map();
  items.forEach(i => {
    const s = setMap.get(i.expansion) || { expansion: i.expansion, verkauft: 0, karten: 0 };
    s.verkauft += i.delta;
    s.karten   += 1;
    setMap.set(i.expansion, s);
  });
  const setRanking = [...setMap.values()].sort((a,b) => b.verkauft - a.verkauft);

  const setRankingHtml = setRanking.map((s,i) =>
    '<tr>' +
    '<td class="num" style="color:var(--text-muted)">' + (i+1) + '</td>' +
    '<td>' + esc(s.expansion) + '</td>' +
    '<td class="num">' + s.karten + '</td>' +
    '<td class="num" style="color:#e05c5c;font-weight:700">' + s.verkauft + '</td>' +
    '</tr>'
  ).join('');

  // Spalten-Definitionen
  const cols = [
    { key:'name',            label:'Kartenname', num:false },
    { key:'rarity',          label:'Seltenheit', num:false },
    { key:'expansion',       label:'Set',        num:false },
    { key:'altQty',          label:'Vorher',     num:true  },
    { key:'neuQty',          label:'Nachher',    num:true  },
    { key:'delta',           label:'Verkauft',   num:true  },
  ];
  const thead = cols.map(col => {
    const s = S.diffSortCol === col.key;
    const arr = s ? (S.diffSortDir === 1 ? 'â–²' : 'â–¼') : 'â–²';
    return '<th class="' + (col.num?'num ':'') + (s?'sorted':'') + '"' +
      ' onclick="sortDiff(\'' + col.key + '\')" scope="col"' +
      ' aria-sort="' + (s?(S.diffSortDir===1?'ascending':'descending'):'none') + '">' +
      esc(col.label) + ' <span class="sort-arrow" aria-hidden="true">' + arr + '</span></th>';
  }).join('');

  const rows = sorted.map(item => {
    const foilTag = item.foilType==='rainbow' ? '<span class="foil-tag rf" title="Rainbow Foil">RF</span>' :
                    item.foilType==='cold'    ? '<span class="foil-tag cf" title="Cold Foil">CF</span>' : '';
    return '<tr>' +
      '<td><span class="dot" style="background:' + getDotColor(item.name) + '" aria-hidden="true"></span>' +
        foilTag + esc(item.name) + '</td>' +
      '<td style="color:' + rarityColor(item.rarity) + ';font-weight:600">' + esc(item.rarity) + '</td>' +
      '<td style="color:var(--text-dim)">' + esc(item.expansion) + '</td>' +
      '<td class="num" style="color:var(--text-muted)">' + item.altQty + '</td>' +
      '<td class="num" style="color:var(--text-muted)">' + item.neuQty + '</td>' +
      '<td class="num"><span class="diff-sold-badge">âˆ’' + item.delta + '</span></td>' +
      '</tr>';
  }).join('');

  return (
    diffFilterBar +
    '<div class="diff-banner">' +
      '<div class="diff-banner-icon">ğŸ“‰</div>' +
      '<div class="diff-banner-text">' +
        '<strong>' + totalSold.toLocaleString('de') + ' StÃ¼ck verkauft Â· ' + totalCards.toLocaleString('de') + ' verschiedene Karten</strong>' +
        '<span class="diff-ts">Vergleich erstellt ' + tsStr + '</span>' +
      '</div>' +
    '</div>' +

    '<h3 style="font-family:var(--font-display);font-size:.875rem;letter-spacing:.06em;text-transform:uppercase;' +
      'color:var(--text-muted);margin:0 0 10px">VerkÃ¤ufe nach Set</h3>' +
    '<div class="table-wrap" style="margin-bottom:28px">' +
    '<table aria-label="VerkÃ¤ufe nach Set">' +
    '<thead><tr>' +
      '<th class="num" scope="col">#</th>' +
      '<th scope="col">Set</th>' +
      '<th class="num" scope="col">Karten</th>' +
      '<th class="num" scope="col">StÃ¼ck</th>' +
    '</tr></thead>' +
    '<tbody>' + setRankingHtml + '</tbody>' +
    '</table></div>' +

    '<h3 style="font-family:var(--font-display);font-size:.875rem;letter-spacing:.06em;text-transform:uppercase;' +
      'color:var(--text-muted);margin:0 0 10px">Alle verkauften Karten</h3>' +
    '<div class="table-wrap">' +
    '<table aria-label="Verkaufte Karten">' +
    '<thead><tr>' + thead + '</tr></thead>' +
    '<tbody>' + rows + '</tbody>' +
    '</table></div>'
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KARTENERFASSUNG (OCR)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let _scanWorker   = null;
let _scanStream   = null;
let _scanInterval = null;
let _scanBusy     = false;
let _lastRecognized = '';
let _lastResultTs   = 0;

function renderScanPanel() {
  const log = S.scan.log;
  const logHtml = log.length === 0
    ? '<p style="color:var(--text-muted);font-size:.8rem;text-align:center;padding:12px">Noch keine Karten gescannt</p>'
    : log.slice().reverse().map(e =>
        '<div class="scan-log-entry ' + (e.needed ? 'scan-log-needed' : 'scan-log-skip') + '">' +
          '<span class="scan-log-icon">' + (e.needed ? 'âœ…' : 'â¬œ') + '</span>' +
          '<span>' + esc(e.name) + '</span>' +
          (e.needed ? '<span class="scan-log-qty">âˆ’' + e.fehlend + '</span>' : '') +
        '</div>'
      ).join('');

  return '<div id="scan-panel">' +
    '<div class="scan-video-wrap">' +
      '<video id="scan-video" autoplay playsinline muted></video>' +
      '<div class="scan-guide-wrap">' +
        '<div class="scan-zone-pitch"><span class="scan-zone-pitch-label">Pitch-Farbe</span></div>' +
        '<div class="scan-zone-name"><span class="scan-zone-name-label">Kartenname</span></div>' +
        '<div class="scan-zone-set"><span class="scan-zone-set-label">Setcode</span></div>' +
      '</div>' +
    '</div>' +
    '<div class="scan-controls">' +
      '<button class="btn-primary" id="btn-scan-start" onclick="startScan()">â–¶ Kamera starten</button>' +
      '<button class="btn" id="btn-scan-stop" onclick="stopScan()" style="display:none">â¹ Stoppen</button>' +
      '<button class="btn" onclick="clearScanLog()">ğŸ—‘ Log leeren</button>' +
    '</div>' +
    '<div class="scan-status" id="scan-status">Kamera inaktiv</div>' +
    '<div id="scan-result" class="scan-result scanning" style="display:none"></div>' +
    '<div class="scan-log">' + logHtml + '</div>' +
  '</div>';
}

async function startScan() {
  const statusEl = document.getElementById('scan-status');
  if (statusEl) statusEl.textContent = 'Kamera wird gestartetâ€¦';

  try {
    _scanStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 } }
    });
  } catch(e) {
    if (statusEl) statusEl.textContent = 'âœ— Kamera nicht verfÃ¼gbar: ' + e.message;
    return;
  }

  const video = document.getElementById('scan-video');
  if (!video) return;
  video.srcObject = _scanStream;

  document.getElementById('btn-scan-start').style.display = 'none';
  document.getElementById('btn-scan-stop').style.display  = '';

  // Tesseract Worker initialisieren
  if (!_scanWorker) {
    if (statusEl) statusEl.textContent = 'OCR-Engine wird geladenâ€¦';
    _scanWorker = await Tesseract.createWorker('eng', 1, {
      workerPath: 'https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.0.4/worker.min.js',
      corePath:   'https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.0.4/tesseract-core.wasm.js',
    });
    await _scanWorker.setParameters({ tessedit_char_whitelist: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz '-," });
  }

  if (statusEl) statusEl.textContent = 'ğŸ” Bereitâ€¦';
  const fb0 = document.getElementById('scan-feedback');
  if (fb0) { fb0.textContent = 'ğŸ“· Karte in den Rahmen halten'; fb0.className = 'scan-feedback-overlay fb-info'; }
  _scanInterval = setInterval(doScanFrame, 1600);
}

function stopScan() {
  clearInterval(_scanInterval);
  _scanInterval = null;
  if (_scanStream) { _scanStream.getTracks().forEach(t => t.stop()); _scanStream = null; }
  const video = document.getElementById('scan-video');
  if (video) video.srcObject = null;
  const startBtn = document.getElementById('btn-scan-start');
  const stopBtn  = document.getElementById('btn-scan-stop');
  if (startBtn) startBtn.style.display = '';
  if (stopBtn)  stopBtn.style.display  = 'none';
  const statusEl = document.getElementById('scan-status');
  if (statusEl) statusEl.textContent = 'Kamera gestoppt';
}

// Pitchwert aus Durchschnittsfarbe des oberen Streifens ermitteln
function detectPitch(ctx, vw, vh) {
  // Zone: obere 10% der Karte, volle Breite (Farbstreifen)
  const y0 = Math.floor(vh * 0.03);
  const h  = Math.floor(vh * 0.09);
  const pixels = ctx.getImageData(Math.floor(vw*0.05), y0, Math.floor(vw*0.9), h).data;
  let r=0, g=0, b=0, n=0;
  for (let i=0; i<pixels.length; i+=4) {
    r += pixels[i]; g += pixels[i+1]; b += pixels[i+2]; n++;
  }
  if (!n) return null;
  r=r/n; g=g/n; b=b/n;
  // Klassifikation: rot=1, gelb=2, blau=3
  if (r > 140 && g < 100 && b < 100) return 1;          // rot
  if (r > 140 && g > 120 && b < 100) return 2;          // gelb/orange
  if (b > 120 && r < 120 && g < 140) return 3;          // blau
  return null; // neutral/keine Pitch-Karte
}

async function doScanFrame() {
  if (_scanBusy) return;
  const video = document.getElementById('scan-video');
  if (!video || video.readyState < 2) return;

  _scanBusy = true;
  try {
    const vw = video.videoWidth, vh = video.videoHeight;

    // Vollbild-Canvas
    const fullCanvas = document.createElement('canvas');
    fullCanvas.width = vw; fullCanvas.height = vh;
    const fullCtx = fullCanvas.getContext('2d');
    fullCtx.drawImage(video, 0, 0);

    // â”€â”€ Live-Feedback: Helligkeit & Textur der Namenszone prÃ¼fen â”€â”€
    // Namenszone: weiÃŸer Balken bei ~16â€“24% der Frame-HÃ¶he
    const nzY = Math.floor(vh * 0.16);
    const nzH = Math.floor(vh * 0.08);
    const nzPx = fullCtx.getImageData(Math.floor(vw*0.15), nzY, Math.floor(vw*0.7), nzH).data;
    let brightness = 0, darkPx = 0, totalPx = 0;
    for (let i = 0; i < nzPx.length; i += 4) {
      const lum = (nzPx[i] + nzPx[i+1] + nzPx[i+2]) / 3;
      brightness += lum; if (lum < 80) darkPx++; totalPx++;
    }
    brightness = totalPx ? brightness / totalPx : 0;
    const textRatio = totalPx ? darkPx / totalPx : 0;

    // Pitch-Streifen-Zone: ~11â€“15% HÃ¶he â€” prÃ¼fen ob hell (Farbe sichtbar)
    const pzPx = fullCtx.getImageData(Math.floor(vw*0.2), Math.floor(vh*0.11), Math.floor(vw*0.6), Math.floor(vh*0.04)).data;
    let pitchBright = 0, pn = 0;
    for (let i = 0; i < pzPx.length; i += 4) { pitchBright += (pzPx[i]+pzPx[i+1]+pzPx[i+2])/3; pn++; }
    pitchBright = pn ? pitchBright / pn : 0;

    // Feedback + Rahmenfarbe setzen
    const fr = document.getElementById('scan-frame');
    const fb = document.getElementById('scan-feedback');
    function setFB(msg, state) {
      if (fb) { fb.textContent = msg; fb.className = 'scan-feedback-overlay fb-' + state; }
      if (fr) fr.className = 'scan-card-frame frame-' + (state === 'ok' ? 'ok' : state === 'warn' ? 'warn' : 'bad');
    }

    if (brightness < 55) {
      setFB('ğŸ’¡ Zu dunkel â€” mehr Licht', 'bad'); _scanBusy = false; return;
    } else if (brightness < 100) {
      setFB('ğŸ’¡ Etwas dunkel â€” mehr Licht hilft', 'warn');
    } else if (pitchBright < 25) {
      setFB('â¬†ï¸ Karte etwas hÃ¶her halten', 'warn');
    } else if (textRatio < 0.018) {
      setFB('ğŸ” NÃ¤her heranhalten', 'warn');
    } else if (textRatio > 0.42) {
      setFB('ğŸ” Etwas weiter weg halten', 'warn');
    } else {
      setFB('âœ“ Position gut â€” lese Karteâ€¦', 'ok');
    }

    // Bei schlechter QualitÃ¤t kein OCR starten
    if (brightness < 70 || textRatio < 0.012) { _scanBusy = false; return; }

    // â”€â”€ Pitch erkennen â”€â”€
    const pitch = detectPitch(fullCtx, vw, vh);

    // â”€â”€ Name-Zone â†’ OCR â”€â”€
    const nameCanvas = document.createElement('canvas');
    const nameY = Math.floor(vh * 0.15);
    const nameH = Math.floor(vh * 0.10);
    nameCanvas.width = vw; nameCanvas.height = nameH;
    const nameCtx = nameCanvas.getContext('2d');
    nameCtx.filter = 'contrast(1.5) brightness(1.1)';
    nameCtx.drawImage(video, 0, nameY, vw, nameH, 0, 0, vw, nameH);

    // â”€â”€ Setcode-Zone â†’ OCR â”€â”€
    const setCanvas = document.createElement('canvas');
    const setY = Math.floor(vh * 0.79);
    const setH = Math.floor(vh * 0.06);
    setCanvas.width = vw; setCanvas.height = setH;
    const setCtx = setCanvas.getContext('2d');
    setCtx.filter = 'contrast(1.8) brightness(1.2)';
    setCtx.drawImage(video, 0, setY, vw, setH, 0, 0, vw, setH);

    // OCR parallel
    const [nameData, setData] = await Promise.all([
      _scanWorker.recognize(nameCanvas),
      _scanWorker.recognize(setCanvas),
    ]);

    const rawName = nameData.data.text.trim().replace(/\n/g,' ').replace(/\s+/g,' ');
    const rawSet  = setData.data.text.trim().replace(/\n/g,' ').replace(/\s+/g,' ');
    const conf    = nameData.data.confidence;

    // Setcode: FAI010 â†’ FAI
    const setMatch  = rawSet.match(/([A-Z]{2,4})\d{3}/);
    const setMatch2 = rawSet.match(/([A-Z]{2,4})/);
    const setCode   = setMatch ? setMatch[1] : (setMatch2 ? setMatch2[1] : null);

    // Status-Zeile
    const pitchLbl = pitch===1?'ğŸ”´1':pitch===2?'ğŸŸ¡2':pitch===3?'ğŸ”µ3':'â€“';
    const statusEl = document.getElementById('scan-status');
    if (statusEl) statusEl.textContent =
      'Pitch ' + pitchLbl + ' Â· Set ' + (setCode||'?') + ' Â· ' + Math.round(conf) + '% Â· "' + rawName.slice(0,22) + '"';

    if (conf < 50 || rawName.length < 3) { _scanBusy = false; return; }

    const matches = findAllMatches(rawName, setCode, pitch);
    if (matches.length > 0) {
      const now = Date.now();
      const key = matches.map(m => m.name + '_' + m.pitch + '_' + m.expansion).join('|');
      if (key === _lastRecognized && now - _lastResultTs < 4000) { _scanBusy = false; return; }
      _lastRecognized = key;
      _lastResultTs   = now;
      setFB('âœ… ' + matches[0].name, 'ok');
      showScanResult(matches);
      logScanEntry(matches);
    } else if (conf > 60) {
      setFB('ğŸ” "' + rawName.slice(0,20) + '" â€” nicht in Fehlerliste', 'warn');
    }

  } catch(e) { console.warn('Scan error', e); }
  _scanBusy = false;
}

function findAllMatches(rawName, setCode, pitch) {
  if (!S.result) return [];
  const needle = rawName.toLowerCase().replace(/[^a-z ']/g, '').trim();
  // Kandidaten: alle Karten mit gutem Name-Match
  const candidates = [];
  ['haupt','andere'].forEach(sek => {
    Object.entries(S.result[sek].setsData).forEach(([expansion, cards]) => {
      cards.forEach(card => {
        const cardName = card.name.toLowerCase().replace(/[^a-z ']/g, '').trim();
        const score = similarity(needle, cardName);
        if (score > 0.52) {
          // Setcode aus expansion extrahieren (erster Teil vor Leerzeichen oder ganzer Name)
          const expCode = (card.expansionCode || expansion.replace(/[^A-Z]/g,'')).slice(0,4);
          candidates.push({ ...card, expansion, expCode, nameScore: score });
        }
      });
    });
  });
  if (candidates.length === 0) return [];

  // Besten Name-Score als Referenz
  const maxScore = Math.max(...candidates.map(c => c.nameScore));
  // Nur Kandidaten mit >= 80% des besten Scores
  let filtered = candidates.filter(c => c.nameScore >= maxScore * 0.8);

  // Setcode-Filter wenn erkannt
  if (setCode && filtered.some(c => c.expCode.startsWith(setCode) || setCode.startsWith(c.expCode))) {
    filtered = filtered.filter(c => c.expCode.startsWith(setCode) || setCode.startsWith(c.expCode));
  }

  // Pitch-Filter: pitch-Wert steckt im Namen (Red=1, Yellow=2, Blue=3) oder in pitchValue-Feld
  if (pitch !== null) {
    const pitchFiltered = filtered.filter(c => {
      const p = c.pitchValue || c.pitch;
      if (p) return parseInt(p) === pitch;
      // Fallback: Farbe im Namen
      const n = c.name.toLowerCase();
      if (pitch===1) return n.includes('(r)') || n.includes('red')   || n.endsWith(' r');
      if (pitch===2) return n.includes('(y)') || n.includes('yellow') || n.endsWith(' y');
      if (pitch===3) return n.includes('(b)') || n.includes('blue')  || n.endsWith(' b');
      return true;
    });
    if (pitchFiltered.length > 0) filtered = pitchFiltered;
  }

  // Deduplizieren nach Name+Pitch+Set, fehlend summieren wenn mehrfach
  const seen = new Map();
  filtered.forEach(c => {
    const key = c.name + '|' + (c.pitchValue||c.pitch||'') + '|' + c.expansion;
    if (!seen.has(key)) seen.set(key, { name: c.name, fehlend: c.fehlend, rarity: c.rarity, expansion: c.expansion, pitch: c.pitchValue || c.pitch || null, nameScore: c.nameScore });
    else seen.get(key).fehlend += c.fehlend;
  });

  return [...seen.values()].sort((a,b) => b.nameScore - a.nameScore).slice(0, 4);
}

// Einfacher Ã„hnlichkeits-Score (Dice-Koeffizient auf Bigrammen)
function similarity(a, b) {
  if (a === b) return 1;
  if (a.length < 2 || b.length < 2) return 0;
  const bigrams = s => { const m = new Map(); for(let i=0;i<s.length-1;i++){const bg=s.slice(i,i+2);m.set(bg,(m.get(bg)||0)+1);} return m; };
  const aB = bigrams(a), bB = bigrams(b);
  let inter = 0;
  aB.forEach((cnt, bg) => { inter += Math.min(cnt, bB.get(bg)||0); });
  return (2 * inter) / (a.length - 1 + b.length - 1);
}

function pitchLabel(p) {
  if (p===1||p==='1') return '<span style="color:#e05c5c">â—1</span>';
  if (p===2||p==='2') return '<span style="color:#c9a84c">â—2</span>';
  if (p===3||p==='3') return '<span style="color:#5b9bd5">â—3</span>';
  return '';
}

function showScanResult(matches) {
  const el = document.getElementById('scan-result');
  if (!el) return;
  el.style.display = '';
  const anyNeeded = matches.some(m => m.fehlend > 0);
  el.className = 'scan-result ' + (anyNeeded ? 'needed' : 'not-needed');

  if (matches.length === 1) {
    const m = matches[0];
    const needed = m.fehlend > 0;
    el.innerHTML =
      '<div class="scan-result-inner">' +
        '<div class="scan-result-icon">' + (needed ? 'âœ…' : 'â¬œ') + '</div>' +
        '<div>' +
          '<div class="scan-result-name">' + esc(m.name) + (m.pitch ? ' ' + pitchLabel(m.pitch) : '') + '</div>' +
          '<div class="scan-result-detail">' + esc(m.rarity) + ' Â· ' + esc(m.expansion) + '</div>' +
        '</div>' +
        '<div class="scan-result-qty' + (needed ? '' : ' zero') + '">' + (needed ? 'âˆ’' + m.fehlend : 'âœ“') + '</div>' +
      '</div>';
  } else {
    // Mehrere Versionen
    el.innerHTML = matches.map(m => {
      const needed = m.fehlend > 0;
      return '<div class="scan-result-inner" style="padding:10px 16px;border-bottom:1px solid var(--border)">' +
        '<div class="scan-result-icon" style="font-size:1.2rem">' + (needed ? 'âœ…' : 'â¬œ') + '</div>' +
        '<div>' +
          '<div class="scan-result-name" style="font-size:.875rem">' + esc(m.name) + (m.pitch ? ' ' + pitchLabel(m.pitch) : '') + '</div>' +
          '<div class="scan-result-detail">' + esc(m.rarity) + ' Â· ' + esc(m.expansion) + '</div>' +
        '</div>' +
        '<div class="scan-result-qty' + (needed ? '' : ' zero') + '" style="font-size:1.1rem">' + (needed ? 'âˆ’' + m.fehlend : 'âœ“') + '</div>' +
      '</div>';
    }).join('');
  }
}

function logScanEntry(matches) {
  matches.forEach(m => {
    S.scan.log.push({ name: m.name, fehlend: m.fehlend, rarity: m.rarity, pitch: m.pitch, needed: m.fehlend > 0 });
  });
  if (S.scan.log.length > 50) S.scan.log = S.scan.log.slice(-50);
  const logEl = document.querySelector('.scan-log');
  if (logEl) {
    const log = S.scan.log;
    logEl.innerHTML = log.slice().reverse().map(e =>
      '<div class="scan-log-entry ' + (e.needed ? 'scan-log-needed' : 'scan-log-skip') + '">' +
        '<span class="scan-log-icon">' + (e.needed ? 'âœ…' : 'â¬œ') + '</span>' +
        '<span>' + esc(e.name) + (e.pitch ? ' ' + pitchLabel(e.pitch) : '') + '</span>' +
        (e.needed ? '<span class="scan-log-qty">âˆ’' + e.fehlend + '</span>' : '') +
      '</div>'
    ).join('');
  }
}

function clearScanLog() {
  S.scan.log = [];
  const logEl = document.querySelector('.scan-log');
  if (logEl) logEl.innerHTML = '<p style="color:var(--text-muted);font-size:.8rem;text-align:center;padding:12px">Noch keine Karten gescannt</p>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXCEL EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportXlsx() {
  if (!S.result) return;
  const r  = S.result;
  const wb = XLSX.utils.book_new();

  // Ranking-Sheets fÃ¼r beide Gruppen
  const mkRankingSheet = (gruppe) => gruppe.ranking.map((row,i) => ({
    'Rang': i+1,
    'Set-Gruppe': SET_GRUPPE[row.expansion]||row.expansion,
    'Set': row.expansion,
    'First Edition': row.first_ed ? 'Ja' : 'Nein',
    'Karten im Set gesamt': row.gesamt,
    'Verschiedene fehlend': row.verschiedene,
    'Karten mit 0 StÃ¼ck': row.null_stueck,
    'Fehlende StÃ¼ck gesamt': row.fehlend_gesamt,
    'Fehlquote %': row.fehlquote,
  }));

  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mkRankingSheet(r.haupt)),  'Ranking - Hauptsets');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mkRankingSheet(r.andere)), 'Ranking - Andere');

  // Hauptsets â€” ein Tab pro Set
  r.haupt.ranking.forEach(row => {
    // Im Export: ungefiltert (alle Seltenheiten, alle Foils)
    const karten = (r.haupt.setsData[row.expansion]||[]).map((k,i) => ({
      'Nr.': k.collectorNumber||'', 'CardmarketID': k.id, 'Kartenname': k.name,
      'Seltenheit': k.rarity, 'Foil': k.foilType==='none' ? '' : k.foilType,
      'Im Inventar': k.im_inv, 'Fehlende Menge': k.fehlend,
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(karten),
      setTabName(row.expansion).slice(0,31));
  });

  // Andere Produkte â€” ein Tab pro Produkt
  r.andere.ranking.forEach(row => {
    const karten = (r.andere.setsData[row.expansion]||[]).map((k,i) => ({
      'Nr.': k.collectorNumber||'', 'CardmarketID': k.id, 'Kartenname': k.name,
      'Seltenheit': k.rarity, 'Foil': k.foilType==='none' ? '' : k.foilType,
      'Im Inventar': k.im_inv, 'Fehlende Menge': k.fehlend,
    }));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(karten),
      ('A_' + setTabName(row.expansion)).slice(0,31));
  });

  const heute = new Date().toISOString().slice(0,10);
  XLSX.writeFile(wb, 'bericht_' + heute + '.xlsx');
  const sm = document.getElementById('status-msg');
  sm.className = 'status-msg done';
  sm.textContent = 'âœ“ bericht_' + heute + '.xlsx heruntergeladen';
}
</script>
</body>
</html>
